<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christopher Tan">

<title>Effects of Temperature and Precipitation on Bike Ridership</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-991b1886d3c685c7aa2b62b80640c7af.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./Home.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./sq2.html" aria-current="page"> 
<span class="menu-text">SQ2: Temperature &amp; Precipitation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://karenn-dotcom.github.io/STA9750-2025-FALL/ind_rep.html"> 
<span class="menu-text">SQ5: Time of Day &amp; Day of Week</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://sabrinazhuu.github.io/STA9750-2025-FALL/individual_report.html"> 
<span class="menu-text">SQ6: E-Bike vs.&nbsp;Classic</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">1. Overview</a></li>
  <li><a href="#data-sources-acquisition" id="toc-data-sources-acquisition" class="nav-link" data-scroll-target="#data-sources-acquisition">2. Data Sources &amp; Acquisition</a>
  <ul class="collapse">
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources">2.1 Data Sources</a></li>
  <li><a href="#data-acquisition-code" id="toc-data-acquisition-code" class="nav-link" data-scroll-target="#data-acquisition-code">2.2 Data Acquisition Code</a></li>
  </ul></li>
  <li><a href="#data-cleaning-preparation-exploration" id="toc-data-cleaning-preparation-exploration" class="nav-link" data-scroll-target="#data-cleaning-preparation-exploration">3. Data Cleaning, Preparation &amp; Exploration</a>
  <ul class="collapse">
  <li><a href="#cleaning-preparation" id="toc-cleaning-preparation" class="nav-link" data-scroll-target="#cleaning-preparation">3.1 Cleaning &amp; Preparation</a></li>
  </ul></li>
  <li><a href="#analytical-strategy" id="toc-analytical-strategy" class="nav-link" data-scroll-target="#analytical-strategy">4. Analytical Strategy</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">5. Results</a>
  <ul class="collapse">
  <li><a href="#main-findings" id="toc-main-findings" class="nav-link" data-scroll-target="#main-findings">5.1 Main Findings</a></li>
  <li><a href="#robustness-validation" id="toc-robustness-validation" class="nav-link" data-scroll-target="#robustness-validation">5.2 Robustness / Validation</a></li>
  </ul></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">6. Visualization</a></li>
  <li><a href="#discussion" id="toc-discussion" class="nav-link" data-scroll-target="#discussion">7. Discussion</a>
  <ul class="collapse">
  <li><a href="#answer" id="toc-answer" class="nav-link" data-scroll-target="#answer">7.1 Answer</a></li>
  <li><a href="#contribution-to-the-oq" id="toc-contribution-to-the-oq" class="nav-link" data-scroll-target="#contribution-to-the-oq">7.2 Contribution to the OQ</a></li>
  </ul></li>
  <li><a href="#limitations-future-work" id="toc-limitations-future-work" class="nav-link" data-scroll-target="#limitations-future-work">8. Limitations &amp; Future Work</a></li>
  <li><a href="#reproducibility-appendix" id="toc-reproducibility-appendix" class="nav-link" data-scroll-target="#reproducibility-appendix">9. Reproducibility Appendix</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Effects of Temperature and Precipitation on Bike Ridership</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christopher Tan </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">1. Overview</h2>
<p>This report will work to examine how daily weather conditions shape Citi Bike demand in Manhattan, with a focus on the effects of temperature and precipitation on total trip volume. This analysis contributes to the broader project question of how several environmental and behavioral factors jointly determine ridership patterns.</p>
<p>The specific question that I’ll be answering is:</p>
<blockquote class="blockquote">
<p><em>How do daily temperature and precipitation levels affect Citi Bike trip volume in Manhattan, and to what extent are these effects non-linear?</em></p>
</blockquote>
</section>
<section id="data-sources-acquisition" class="level2">
<h2 class="anchored" data-anchor-id="data-sources-acquisition">2. Data Sources &amp; Acquisition</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Goal:</strong><br>
Construct a daily, Manhattan-focused panel that links Citi Bike ridership to local weather conditions using fully reproducible data pipelines.</p>
</div>
</div>
<section id="data-sources" class="level3">
<h3 class="anchored" data-anchor-id="data-sources">2.1 Data Sources</h3>
<section id="citi-bike-data" class="level4">
<h4 class="anchored" data-anchor-id="citi-bike-data">Citi Bike Data</h4>
<p>Citi Bike trip data provide near-census coverage of all trips taken on the system during the study period (October 2024 through October 2025). Each trip record includes timestamps, start and end locations, and rider type indicators, allowing trips to be aggregated reliably to the daily level.</p>
</section>
<section id="open-meteo-api" class="level4">
<h4 class="anchored" data-anchor-id="open-meteo-api">Open-Meteo API</h4>
<p>Daily weather data are obtained from the Open-Meteo archive API and include mean daily temperature and total daily precipitation. Observations are drawn from a central Manhattan location to provide a consistent approximation of weather conditions experienced by riders across the borough.</p>
<p>Weather variables are measured at the daily level to match the temporal resolution of aggregated trip counts.</p>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Why these data work together</strong><br>
Citi Bike data capture <em>what</em> riders do, while weather data capture <em>the conditions under which those decisions are made</em>. Linking the two allows us to estimate how short-term conditions translate into changes in demand.</p>
</div>
</div>
</section>
</section>
<section id="data-acquisition-code" class="level3">
<h3 class="anchored" data-anchor-id="data-acquisition-code">2.2 Data Acquisition Code</h3>
<p>All data are acquired programmatically to ensure reproducibility and transparency.</p>
<section id="trip-data-ingestion" class="level4">
<h4 class="anchored" data-anchor-id="trip-data-ingestion">Trip data ingestion</h4>
<p>Citi Bike trip files are downloaded directly from the official system S3 repository on a month-by-month basis. Downloads are wrapped in retry logic with incremental backoff to guard against transient network failures. Files are retrieved only if they are not already present locally, avoiding unnecessary re-downloads.</p>
<p>Trip files are read using a targeted column selection to reduce memory usage and improve processing speed.</p>
</section>
<section id="spatial-filtering" class="level4">
<h4 class="anchored" data-anchor-id="spatial-filtering">Spatial filtering</h4>
<p>Manhattan is defined using an official NYC borough boundary shapefile obtained from the NYC Department of City Planning. The geometry is transformed to a standard WGS84 coordinate reference system and used to filter trips via a GIS point-in-polygon operation.</p>
<p>Only trips whose <strong>starting coordinates</strong> fall within the Manhattan boundary are retained. This spatial filtering approach avoids reliance on station naming conventions and ensures consistent geographic classification across all months.</p>
</section>
<section id="weather-data-ingestion" class="level4">
<h4 class="anchored" data-anchor-id="weather-data-ingestion">Weather data ingestion</h4>
<p>Weather data are retrieved via parameterized API requests specifying location, date range, units, and time zone. API responses are validated before being converted into a structured daily dataset containing temperature and precipitation measures.</p>
</section>
<section id="caching-and-reuse" class="level4">
<h4 class="anchored" data-anchor-id="caching-and-reuse">Caching and reuse</h4>
<p>All intermediate and final datasets are saved as compressed RDS files. This design allows downstream analyses to load clean, analysis-ready data without repeating download or cleaning steps, ensuring both efficiency and reproducibility across scripts.</p>
<div class="callout-success">
<p><strong>Resulting dataset</strong><br>
A clean, spatially accurate, daily panel linking Manhattan-origin Citi Bike trips to local weather conditions, suitable for exploratory analysis and non-linear modeling.</p>
</div>
</section>
</section>
</section>
<section id="data-cleaning-preparation-exploration" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning-preparation-exploration">3. Data Cleaning, Preparation &amp; Exploration</h2>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Goal of this section:</strong><br>
Prepare a clean, spatially accurate, and analysis-ready dataset that reflects rider decision-making at the start of each Citi Bike trip.</p>
</div>
</div>
<section id="cleaning-preparation" class="level3">
<h3 class="anchored" data-anchor-id="cleaning-preparation">3.1 Cleaning &amp; Preparation</h3>
<section id="defining-the-spatial-scope" class="level4">
<h4 class="anchored" data-anchor-id="defining-the-spatial-scope">Defining the spatial scope</h4>
<p>To ensure precise geographic filtering, Manhattan was defined using an official NYC borough boundary shapefile. The geometry was transformed to the WGS84 coordinate reference system to better align with the latitude and longitude values reported in the Citi Bike data.</p>
<p>This GIS-based definition avoids reliance on station names or borough labels, which may be incomplete or inconsistently reported, and instead grounds spatial filtering in geometry.</p>
</section>
<section id="importing-and-standardizing-trip-data" class="level4">
<h4 class="anchored" data-anchor-id="importing-and-standardizing-trip-data">Importing and standardizing trip data</h4>
<p>Trip data were downloaded month-by-month and processed using a consistent directory structure to support reproducibility. For each CSV file, only variables required for analysis were imported, reducing memory overhead and keeping the dataset focused.</p>
<p>Trip start and end times were converted to timezone-aware datetime objects using local New York time. From these timestamps, additional temporal variables, such as date and hour, were derived to support daily aggregation and exploratory analysis.</p>
</section>
<section id="handling-missing-and-invalid-records" class="level4">
<h4 class="anchored" data-anchor-id="handling-missing-and-invalid-records">Handling missing and invalid records</h4>
<p>Trips with missing starting latitude or longitude were excluded prior to spatial filtering, as geographic classification requires valid coordinate information. This step removes records that cannot be reliably assigned to a borough.</p>
</section>
<section id="gis-based-manhattan-filtering" class="level4">
<h4 class="anchored" data-anchor-id="gis-based-manhattan-filtering">GIS-based Manhattan filtering</h4>
<p>Starting coordinates were converted into spatial point objects and evaluated using a point-in-polygon operation against the Manhattan boundary. Only trips whose <strong>starting location</strong> fell within Manhattan were retained.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Why filter on trip start?</strong><br>
Rider decisions are made at the beginning of a trip. As such, we ultimately decided that restricting our analysis to trips that start in Manhattan reflects demand originating from within the borough, rather than trips that merely pass through or end there.</p>
</div>
</div>
</section>
<section id="dataset-consolidation-and-storage" class="level4">
<h4 class="anchored" data-anchor-id="dataset-consolidation-and-storage">Dataset consolidation and storage</h4>
<p>Cleaned trips were combined across CSV chunks within each month, then concatenated across all months into a single dataset spanning October 2024 through October 2025. The resulting dataset was then saved as a compressed RDS file to enable for fast loading and consistent reuse in subsequent steps.</p>
</section>
</section>
</section>
<section id="analytical-strategy" class="level2">
<h2 class="anchored" data-anchor-id="analytical-strategy">4. Analytical Strategy</h2>
<p>Daily trip counts are modeled as a function of weather using Generalized Additive Models (GAMs). Preliminary exploration revealed strong departures from linearity in the relationship between temperature and ridership, motivating the use of flexible smooth terms rather than parametric regression.</p>
<p>GAMs allow the data to determine functional form while maintaining interpretability. Smoothness is constrained to avoid overfitting, and model adequacy is assessed using effective degrees of freedom and deviance explained. This approach balances flexibility with transparency and is well-suited to isolating weather-driven demand effects.</p>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">5. Results</h2>
<section id="main-findings" class="level3">
<h3 class="anchored" data-anchor-id="main-findings">5.1 Main Findings</h3>
<p>Temperature exhibits a strong and statistically significant non-linear association with daily trip volume. Ridership increases rapidly as temperatures rise from cold to mild conditions, but marginal gains diminish at higher temperatures, indicating a comfort threshold beyond which additional warmth does not increase demand.</p>
<p>Precipitation reduces ridership in an asymmetric manner. Light rain has limited impact on typical daily usage, while moderate to heavy rainfall leads to substantial declines in trip volume, particularly in the upper tail of the distribution.</p>
</section>
<section id="robustness-validation" class="level3">
<h3 class="anchored" data-anchor-id="robustness-validation">5.2 Robustness / Validation</h3>
</section>
</section>
<section id="visualization" class="level2">
<h2 class="anchored" data-anchor-id="visualization">6. Visualization</h2>
</section>
<section id="discussion" class="level2">
<h2 class="anchored" data-anchor-id="discussion">7. Discussion</h2>
<section id="answer" class="level3">
<h3 class="anchored" data-anchor-id="answer">7.1 Answer</h3>
</section>
<section id="contribution-to-the-oq" class="level3">
<h3 class="anchored" data-anchor-id="contribution-to-the-oq">7.2 Contribution to the OQ</h3>
<p>This weather-focused analysis makes an irreplaceable contribution to the overarching question by separating short-run demand suppression from longer-run structural determinants of ridership. Without explicitly modeling non-linear weather effects, analyses of time-of-day patterns, rider type, or infrastructure risk attributing weather-driven fluctuations to persistent system features. By isolating these effects, this report provides a necessary baseline against which other project components can be interpreted.</p>
</section>
</section>
<section id="limitations-future-work" class="level2">
<h2 class="anchored" data-anchor-id="limitations-future-work">8. Limitations &amp; Future Work</h2>
</section>
<section id="reproducibility-appendix" class="level2">
<h2 class="anchored" data-anchor-id="reproducibility-appendix">9. Reproducibility Appendix</h2>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>