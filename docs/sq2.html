<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Christopher Tan">

<title>Effects of Temperature and Precipitation on Bike Ridership</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-991b1886d3c685c7aa2b62b80640c7af.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./Home.html"> 
<span class="menu-text">Group Report</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://starnovalight.github.io/STA9750-2025-FALL/pop00.html"> 
<span class="menu-text">SQ1: Most Popular Routes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://thecyclepaths.netlify.app/sq2.html"> 
<span class="menu-text">SQ2: Temperature vs.&nbsp;Precipitation</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://jiminhong123.github.io/STA9750-2025-FALL/Individual_report.html"> 
<span class="menu-text">SQ3: Members vs.&nbsp;Casual Riders</span></a>
  </li>  
  <li class="nav-item">
    <span class="nav-link">
<span class="menu-text">SQ4: Protected vs. Shared Bike Lanes</span>
    </span>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://karenn-dotcom.github.io/STA9750-2025-FALL/ind_rep.html"> 
<span class="menu-text">SQ5: Time of Day &amp; Day of Week</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://sabrinazhuu.github.io/STA9750-2025-FALL/individual_report.html"> 
<span class="menu-text">SQ6: E-Bike vs.&nbsp;Classic Bike</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">1. Overview</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">2. Data Preparation</a>
  <ul class="collapse">
  <li><a href="#install-packages" id="toc-install-packages" class="nav-link" data-scroll-target="#install-packages">Install packages</a></li>
  <li><a href="#directories" id="toc-directories" class="nav-link" data-scroll-target="#directories">Directories</a></li>
  <li><a href="#download-settings" id="toc-download-settings" class="nav-link" data-scroll-target="#download-settings">Download Settings</a></li>
  <li><a href="#time-window" id="toc-time-window" class="nav-link" data-scroll-target="#time-window">Time Window</a></li>
  <li><a href="#download-manhattan-polygon-gis" id="toc-download-manhattan-polygon-gis" class="nav-link" data-scroll-target="#download-manhattan-polygon-gis">Download Manhattan Polygon (GIS)</a></li>
  <li><a href="#download-from-open-meteo" id="toc-download-from-open-meteo" class="nav-link" data-scroll-target="#download-from-open-meteo">Download from Open-Meteo</a></li>
  </ul></li>
  <li><a href="#data-filtering" id="toc-data-filtering" class="nav-link" data-scroll-target="#data-filtering">3. Data Filtering</a>
  <ul class="collapse">
  <li><a href="#download-unzip-read-filter-for-manhattan-only-trips" id="toc-download-unzip-read-filter-for-manhattan-only-trips" class="nav-link" data-scroll-target="#download-unzip-read-filter-for-manhattan-only-trips">Download, Unzip, Read, Filter for Manhattan Only Trips</a></li>
  </ul></li>
  <li><a href="#join-bike-and-weather-data" id="toc-join-bike-and-weather-data" class="nav-link" data-scroll-target="#join-bike-and-weather-data">4. Join Bike and Weather Data</a>
  <ul class="collapse">
  <li><a href="#eda-summary-check" id="toc-eda-summary-check" class="nav-link" data-scroll-target="#eda-summary-check">EDA: Summary Check</a></li>
  <li><a href="#eda-outlier-check" id="toc-eda-outlier-check" class="nav-link" data-scroll-target="#eda-outlier-check">EDA: Outlier Check</a></li>
  <li><a href="#eda-precipitation-threshold" id="toc-eda-precipitation-threshold" class="nav-link" data-scroll-target="#eda-precipitation-threshold">EDA: Precipitation Threshold</a></li>
  </ul></li>
  <li><a href="#plot-data" id="toc-plot-data" class="nav-link" data-scroll-target="#plot-data">5. Plot Data</a></li>
  <li><a href="#results" id="toc-results" class="nav-link" data-scroll-target="#results">6. Results</a>
  <ul class="collapse">
  <li><a href="#what-the-precipitation-figure-shows" id="toc-what-the-precipitation-figure-shows" class="nav-link" data-scroll-target="#what-the-precipitation-figure-shows">What the precipitation figure shows</a></li>
  <li><a href="#what-the-temperature-figure-shows" id="toc-what-the-temperature-figure-shows" class="nav-link" data-scroll-target="#what-the-temperature-figure-shows">What the temperature figure shows</a></li>
  <li><a href="#putting-temperature-and-precipitation-together" id="toc-putting-temperature-and-precipitation-together" class="nav-link" data-scroll-target="#putting-temperature-and-precipitation-together">Putting temperature and precipitation together</a></li>
  </ul></li>
  <li><a href="#further-analysis-temperature-vs.-precipitation" id="toc-further-analysis-temperature-vs.-precipitation" class="nav-link" data-scroll-target="#further-analysis-temperature-vs.-precipitation">7. Further Analysis: Temperature vs.&nbsp;Precipitation</a>
  <ul class="collapse">
  <li><a href="#load-datasets" id="toc-load-datasets" class="nav-link" data-scroll-target="#load-datasets">1. Load Datasets</a></li>
  <li><a href="#define-the-outcome-variable" id="toc-define-the-outcome-variable" class="nav-link" data-scroll-target="#define-the-outcome-variable">2. Define the outcome variable</a></li>
  <li><a href="#select-weather-predictors" id="toc-select-weather-predictors" class="nav-link" data-scroll-target="#select-weather-predictors">3. Select weather predictors</a></li>
  <li><a href="#create-the-modeling-dataset" id="toc-create-the-modeling-dataset" class="nav-link" data-scroll-target="#create-the-modeling-dataset">4. Create the modeling dataset</a></li>
  <li><a href="#use-a-traintest-split" id="toc-use-a-traintest-split" class="nav-link" data-scroll-target="#use-a-traintest-split">5. Use a train/test split</a></li>
  <li><a href="#fit-and-evaluate-models" id="toc-fit-and-evaluate-models" class="nav-link" data-scroll-target="#fit-and-evaluate-models">6. Fit and evaluate models</a></li>
  <li><a href="#baseline-model" id="toc-baseline-model" class="nav-link" data-scroll-target="#baseline-model">7. Baseline model</a></li>
  <li><a href="#loco-temperature-vs.-precipitation" id="toc-loco-temperature-vs.-precipitation" class="nav-link" data-scroll-target="#loco-temperature-vs.-precipitation">8. LOCO: Temperature vs.&nbsp;Precipitation</a></li>
  <li><a href="#interpreting-the-results" id="toc-interpreting-the-results" class="nav-link" data-scroll-target="#interpreting-the-results">9. Interpreting the results</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Effects of Temperature and Precipitation on Bike Ridership</h1><button type="button" class="btn code-tools-button dropdown-toggle" id="quarto-code-tools-menu" data-bs-toggle="dropdown" aria-expanded="false"><i class="bi"></i> Code</button><ul class="dropdown-menu dropdown-menu-end" aria-labelelledby="quarto-code-tools-menu"><li><a id="quarto-show-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Show All Code</a></li><li><a id="quarto-hide-all-code" class="dropdown-item" href="javascript:void(0)" role="button">Hide All Code</a></li><li><hr class="dropdown-divider"></li><li><a id="quarto-view-source" class="dropdown-item" href="javascript:void(0)" role="button">View Source</a></li></ul></div></div>
</div>



<div class="quarto-title-meta column-page-left">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Christopher Tan </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">1. Overview</h2>
<p>Citi Bike demand can change substantially from one day to the next, and weather is one of the most direct reasons why. Unlike long recreational rides, many Citi Bike trips in Manhattan are short, purpose driven trips such as commutes to work, quick errands, or first and last mile connections to the subway. Because these trips are often discretionary at the margin, riders continuously weigh the convenience of biking against comfort and perceived safety.</p>
<p>Temperature plays a key role in this decision making process. Warmer days generally lower the physical and mental barrier to riding, making biking feel easier and more pleasant, which can lead to higher overall trip volume. In contrast, colder days can discourage riding due to discomfort. Precipitation adds another layer of friction by reducing comfort and increasing safety concerns such as slippery roads and reduced visibility, leading some riders to choose alternative modes of transportation.</p>
<p>Together, these patterns suggest that daily weather conditions may systematically influence Citi Bike usage. To quantify this relationship and move beyond intuition, this analysis focuses on the following question:</p>
<blockquote class="blockquote">
<p><em>How do daily temperature and precipitation levels affect Citi Bike trip volume in Manhattan?</em></p>
</blockquote>
</section>
<section id="data-preparation" class="level2">
<h2 class="anchored" data-anchor-id="data-preparation">2. Data Preparation</h2>
<section id="install-packages" class="level3">
<h3 class="anchored" data-anchor-id="install-packages">Install packages</h3>
<p>First, we must load the following:</p>
<ul>
<li><p><code>data.table</code> for fast CSV reading and big-data manipulation</p></li>
<li><p><code>sf</code> for spatial operations (point-in-polygon)</p></li>
<li><p><code>utils</code> for downloads</p></li>
<li><p><code>httr</code> + <code>jsonlite</code> for calling the weather API and parsing JSON</p></li>
<li><p><code>htmltools</code> for the iFrame embed</p></li>
<li><p><code>gt</code> for creating clean tables in Quarto</p></li>
<li><p><code>ranger</code> for fitting fast random forest models</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Linking to GEOS 3.13.0, GDAL 3.10.1, PROJ 9.5.1; sf_use_s2() is TRUE</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(utils)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmltools)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="directories" class="level3">
<h3 class="anchored" data-anchor-id="directories">Directories</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>raw_dir <span class="ot">&lt;-</span> <span class="st">"data/raw"</span>          <span class="co"># zipped tripdata</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="st">"data/processed"</span>    <span class="co"># cleaned outputs</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>gis_dir <span class="ot">&lt;-</span> <span class="st">"data/gis"</span>          <span class="co"># borough shapefile</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(raw_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(out_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(gis_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-settings" class="level3">
<h3 class="anchored" data-anchor-id="download-settings">Download Settings</h3>
<p>Two stability tweaks for large downloads:</p>
<ul>
<li><p>longer timeout</p></li>
<li><p><code>libcurl</code> download method</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">download.file.method =</span> <span class="st">"libcurl"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="time-window" class="level3">
<h3 class="anchored" data-anchor-id="time-window">Time Window</h3>
<p>Define the month labels Citi Bike uses (<code>YYYYMM</code>) and the base URL.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">format</span>(</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-10-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2025-10-01"</span>), <span class="at">by =</span> <span class="st">"month"</span>),</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"%Y%m"</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://s3.amazonaws.com/tripdata"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-manhattan-polygon-gis" class="level3">
<h3 class="anchored" data-anchor-id="download-manhattan-polygon-gis">Download Manhattan Polygon (GIS)</h3>
<p>We must download NYC borough boundaries, read them as an <code>sf</code> object, convert to standard lat/lon (EPSG:4326), then extract <strong>only Manhattan</strong> as <code>manhattan_poly</code>. That polygon is used later to filter trips.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>borough_url <span class="ot">&lt;-</span> <span class="st">"https://www.nyc.gov/assets/planning/download/zip/data-maps/open-data/nybb_16a.zip"</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>borough_zip <span class="ot">&lt;-</span> <span class="fu">file.path</span>(gis_dir, <span class="st">"nyc_boroughs.zip"</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(borough_zip)) {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Downloading NYC borough boundaries shapefile..."</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(borough_url, borough_zip, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(borough_zip, <span class="at">exdir =</span> gis_dir)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>shp_file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(gis_dir, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.shp$"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(shp_file)) <span class="fu">stop</span>(<span class="st">"No .shp file found in "</span>, gis_dir, <span class="st">" after unzip."</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>boroughs <span class="ot">&lt;-</span> <span class="fu">st_read</span>(shp_file, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>boroughs <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(boroughs, <span class="dv">4326</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"BoroName"</span> <span class="sc">%in%</span> <span class="fu">names</span>(boroughs))) {</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Could not find a 'BoroName' column in borough shapefile."</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>manhattan_poly <span class="ot">&lt;-</span> boroughs[boroughs<span class="sc">$</span>BoroName <span class="sc">==</span> <span class="st">"Manhattan"</span>, ]</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(manhattan_poly) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Manhattan polygon not found in boroughs shapefile."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="download-from-open-meteo" class="level3">
<h3 class="anchored" data-anchor-id="download-from-open-meteo">Download from Open-Meteo</h3>
<p>Set location:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># used Midtown as our reference point</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>latitude  <span class="ot">&lt;-</span> <span class="fl">40.75493</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>longitude <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">73.98402</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Query Open-Meteo for daily:</p>
<ul>
<li><p>mean temperature (<code>temperature_2m_mean</code>)</p></li>
<li><p>precipitation sum (<code>precipitation_sum</code>)</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>get_monthly_weather <span class="ot">&lt;-</span> <span class="cf">function</span>(lat, lon, start_date, end_date, <span class="at">max_attempts =</span> <span class="dv">5</span>) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use archive endpoint for past dates (more appropriate for historical pulls)</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>  base_url <span class="ot">&lt;-</span> <span class="st">"https://api.open-meteo.com/v1/forecast"</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">as.Date</span>(start_date) <span class="sc">&lt;</span> <span class="fu">Sys.Date</span>()) {</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://archive-api.open-meteo.com/v1/archive"</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude           =</span> lat,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude          =</span> lon,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_date         =</span> start_date,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_date           =</span> end_date,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">daily              =</span> <span class="st">"temperature_2m_mean,precipitation_sum"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">temperature_unit   =</span> <span class="st">"fahrenheit"</span>,</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">precipitation_unit =</span> <span class="st">"inch"</span>,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">timezone           =</span> <span class="st">"America/New_York"</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (attempt <span class="cf">in</span> <span class="fu">seq_len</span>(max_attempts)) {</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Robust request: longer timeout + safe error handling</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>      <span class="fu">GET</span>(base_url, <span class="at">query =</span> params, <span class="fu">timeout</span>(<span class="dv">60</span>)),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) e</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the request failed (DNS/timeout/etc.), retry with backoff</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(resp, <span class="st">"error"</span>)) {</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Weather request error (attempt "</span>, attempt, <span class="st">"): "</span>, resp<span class="sc">$</span>message)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">2</span> <span class="sc">^</span> attempt)</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If server returns non-200, retry (could be temporary)</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">status_code</span>(resp) <span class="sc">!=</span> <span class="dv">200</span>) {</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Weather request failed (attempt "</span>, attempt, <span class="st">") status: "</span>,</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>              <span class="fu">status_code</span>(resp))</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">2</span> <span class="sc">^</span> attempt)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse JSON</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(resp, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>))</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If daily data is missing, retry</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(dat<span class="sc">$</span>daily<span class="sc">$</span>time)) {</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"No daily data returned (attempt "</span>, attempt, <span class="st">") for "</span>,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>              start_date, <span class="st">"–"</span>, end_date)</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">2</span> <span class="sc">^</span> attempt)</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Success: return clean daily table</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>      <span class="at">date        =</span> <span class="fu">as.Date</span>(dat<span class="sc">$</span>daily<span class="sc">$</span>time),</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>      <span class="at">temp_mean_F =</span> dat<span class="sc">$</span>daily<span class="sc">$</span>temperature_2m_mean,</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>      <span class="at">precip_in   =</span> dat<span class="sc">$</span>daily<span class="sc">$</span>precipitation_sum</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"Failed to fetch weather after "</span>, max_attempts, <span class="st">" attempts for "</span>,</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>          start_date, <span class="st">"–"</span>, end_date)</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Build a list of month ranges, call the API month-by-month, combine results, and save.</p>
<ul>
<li><p><code>Sys.sleep(0.5)</code> is a rate-limit to reduce API stress</p></li>
<li><p><code>head()</code>/<code>tail()</code> prints are quick checks to make sure that data has properly settled</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>date_ranges <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2024-10-01"</span>, <span class="at">end =</span> <span class="st">"2024-10-31"</span>),</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2024-11-01"</span>, <span class="at">end =</span> <span class="st">"2024-11-30"</span>),</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2024-12-01"</span>, <span class="at">end =</span> <span class="st">"2024-12-31"</span>),</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-01-01"</span>, <span class="at">end =</span> <span class="st">"2025-01-31"</span>),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-02-01"</span>, <span class="at">end =</span> <span class="st">"2025-02-28"</span>),</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-03-01"</span>, <span class="at">end =</span> <span class="st">"2025-03-31"</span>),</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-04-01"</span>, <span class="at">end =</span> <span class="st">"2025-04-30"</span>),</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-05-01"</span>, <span class="at">end =</span> <span class="st">"2025-05-31"</span>),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-06-01"</span>, <span class="at">end =</span> <span class="st">"2025-06-30"</span>),</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-07-01"</span>, <span class="at">end =</span> <span class="st">"2025-07-31"</span>),</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-08-01"</span>, <span class="at">end =</span> <span class="st">"2025-08-31"</span>),</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-09-01"</span>, <span class="at">end =</span> <span class="st">"2025-09-30"</span>),</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-10-01"</span>, <span class="at">end =</span> <span class="st">"2025-10-31"</span>)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Getting daily weather data for Manhattan</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Getting daily weather data for Manhattan</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>weather_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(date_ranges))</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(date_ranges)) {</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  dr <span class="ot">&lt;-</span> date_ranges[[i]]</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  "</span>, dr<span class="sc">$</span>start, <span class="st">"–"</span>, dr<span class="sc">$</span>end, <span class="st">"...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  weather_list[[i]] <span class="ot">&lt;-</span> <span class="fu">get_monthly_weather</span>(latitude, longitude, dr<span class="sc">$</span>start, dr<span class="sc">$</span>end)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   2024-10-01 – 2024-10-31 ...
   2024-11-01 – 2024-11-30 ...
   2024-12-01 – 2024-12-31 ...
   2025-01-01 – 2025-01-31 ...
   2025-02-01 – 2025-02-28 ...
   2025-03-01 – 2025-03-31 ...
   2025-04-01 – 2025-04-30 ...
   2025-05-01 – 2025-05-31 ...
   2025-06-01 – 2025-06-30 ...
   2025-07-01 – 2025-07-31 ...
   2025-08-01 – 2025-08-31 ...
   2025-09-01 – 2025-09-30 ...
   2025-10-01 – 2025-10-31 ...</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>weather_daily <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(weather_list, <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(weather_daily))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         date temp_mean_F precip_in
       &lt;Date&gt;       &lt;num&gt;     &lt;num&gt;
1: 2024-10-01        63.0     0.000
2: 2024-10-02        61.2     0.000
3: 2024-10-03        63.6     0.004
4: 2024-10-04        63.3     0.008
5: 2024-10-05        64.9     0.016
6: 2024-10-06        60.6     0.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">tail</span>(weather_daily))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>         date temp_mean_F precip_in
       &lt;Date&gt;       &lt;num&gt;     &lt;num&gt;
1: 2025-10-26        49.8     0.004
2: 2025-10-27        45.9     0.000
3: 2025-10-28        47.5     0.000
4: 2025-10-29        50.3     0.004
5: 2025-10-30        56.7     1.748
6: 2025-10-31        52.6     0.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>weather_out <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"weather_daily_10036_202410_202510.rds"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(weather_daily, weather_out)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Saved daily weather to: "</span>, weather_out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Saved daily weather to: data/processed/weather_daily_10036_202410_202510.rds</code></pre>
</div>
</div>
</section>
</section>
<section id="data-filtering" class="level2">
<h2 class="anchored" data-anchor-id="data-filtering">3. Data Filtering</h2>
<section id="download-unzip-read-filter-for-manhattan-only-trips" class="level3">
<h3 class="anchored" data-anchor-id="download-unzip-read-filter-for-manhattan-only-trips">Download, Unzip, Read, Filter for Manhattan Only Trips</h3>
<p>First, we must download all files relevant to October 2024 to October 2025 from the Citi Bike website.</p>
<p>Afterwards, we must filter for Manhattan only trips. For one month <code>m</code>, return a <code>data.table</code> containing only trips whose <strong>starting latitude/longitude</strong> falls inside Manhattan.</p>
<div class="callout callout-style-default callout-note callout-titled" title="Why start location only?">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Why start location only?
</div>
</div>
<div class="callout-body-container callout-body">
<p>We filter trips by <strong>starting latitude/longitude</strong> because that’s where riders actually makes the decision to rent a bike, so it best reflects <em>Manhattan demand</em>.</p>
<p><strong>Limitations:</strong> This will still include trips that end outside Manhattan, while excluding trips that <em>start outside</em> Manhattan but end inside. It also assumes the recorded start coordinates are accurate.</p>
</div>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>download_zip <span class="ot">&lt;-</span> <span class="cf">function</span>(m, <span class="at">max_attempts =</span> <span class="dv">5</span>) {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  zip_name <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s-citibike-tripdata.zip"</span>, m)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  zip_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(raw_dir, zip_name)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  zip_url  <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"/"</span>, zip_name)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(zip_path)) {</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Zip already exists: "</span>, zip_name)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(zip_path)</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (attempt <span class="cf">in</span> <span class="fu">seq_len</span>(max_attempts)) {</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Downloading (attempt "</span>, attempt, <span class="st">"): "</span>, zip_name)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(zip_path)) <span class="fu">file.remove</span>(zip_path)</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>      utils<span class="sc">::</span><span class="fu">download.file</span>(zip_url, zip_path, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"  Download error: "</span>, <span class="fu">conditionMessage</span>(e))</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>      <span class="cn">FALSE</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (ok <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(zip_path)) {</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"  Download complete: "</span>, zip_name)</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(zip_path)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">10</span> <span class="sc">*</span> attempt)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Failed to download after "</span>, max_attempts, <span class="st">" attempts: "</span>, zip_url)</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>process_month_manhattan <span class="ot">&lt;-</span> <span class="cf">function</span>(m) {</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>  zip_name <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s-citibike-tripdata.zip"</span>, m)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>  zip_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(raw_dir, zip_name)</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download if missing</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_path)) {</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>    zip_path <span class="ot">&lt;-</span> <span class="fu">download_zip</span>(m)</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> Processing month: "</span>, m)</span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1) Unzip to a temporary directory</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>  tmpdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), m)</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(tmpdir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(zip_path, <span class="at">exdir =</span> tmpdir)</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2) List CSV files inside the unzipped folder</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>  csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(tmpdir, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(csv_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"No CSV files found in "</span>, zip_path)</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlink</span>(tmpdir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>  month_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(csv_files))</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3) Process each CSV</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(csv_files)) {</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    csv <span class="ot">&lt;-</span> csv_files[i]</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  Reading: "</span>, <span class="fu">basename</span>(csv))</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">fread</span>(</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>      csv,</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">select =</span> <span class="fu">c</span>(</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">"started_at"</span>,</span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ended_at"</span>,</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"start_lat"</span>, <span class="st">"start_lng"</span></span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to POSIXct</span></span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>    dt[, started_at <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(started_at, <span class="at">tz =</span> <span class="st">"America/New_York"</span>)]</span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>    dt[, ended_at   <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(ended_at,   <span class="at">tz =</span> <span class="st">"America/New_York"</span>)]</span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Date/hour format</span></span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>    dt[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(started_at)]</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>    dt[, hour <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(<span class="fu">format</span>(started_at, <span class="st">"%H"</span>))]</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GIS filter: keep only trips whose starting long. and lat. point are in Manhattan </span></span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) Drop rows with missing start coordinates</span></span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    n_before <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt)</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> dt[<span class="sc">!</span><span class="fu">is.na</span>(start_lat) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(start_lng)]</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    n_after  <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt)</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_after <span class="sc">==</span> <span class="dv">0</span>L) {</span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"    All rows in this CSV had missing start coords; skipping."</span>)</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>      month_list[[i]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_after <span class="sc">&lt;</span> n_before) {</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"    Dropped "</span>, n_before <span class="sc">-</span> n_after, <span class="st">" rows with missing start coords."</span>)</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Convert start coordinates to sf points</span></span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>    dt_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>      dt,</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"start_lng"</span>, <span class="st">"start_lat"</span>),</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">crs =</span> <span class="dv">4326</span>,</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) Keep only points inside Manhattan polygon</span></span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>    inside_manhattan <span class="ot">&lt;-</span> <span class="fu">st_within</span>(dt_sf, manhattan_poly, <span class="at">sparse =</span> <span class="cn">FALSE</span>)[, <span class="dv">1</span>]</span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>    dt_manhattan <span class="ot">&lt;-</span> dt_sf[inside_manhattan, ]</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-112"><a href="#cb20-112" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) Drop geometry to go back to data.table</span></span>
<span id="cb20-113"><a href="#cb20-113" aria-hidden="true" tabindex="-1"></a>    dt_manhattan <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">st_drop_geometry</span>(dt_manhattan))</span>
<span id="cb20-114"><a href="#cb20-114" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-115"><a href="#cb20-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(dt_manhattan) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb20-116"><a href="#cb20-116" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"    No Manhattan-start trips in this chunk after GIS filter."</span>)</span>
<span id="cb20-117"><a href="#cb20-117" aria-hidden="true" tabindex="-1"></a>      month_list[[i]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb20-118"><a href="#cb20-118" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb20-119"><a href="#cb20-119" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb20-120"><a href="#cb20-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-121"><a href="#cb20-121" aria-hidden="true" tabindex="-1"></a>    month_list[[i]] <span class="ot">&lt;-</span> dt_manhattan</span>
<span id="cb20-122"><a href="#cb20-122" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb20-123"><a href="#cb20-123" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(dt, dt_sf, dt_manhattan)</span>
<span id="cb20-124"><a href="#cb20-124" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb20-125"><a href="#cb20-125" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-126"><a href="#cb20-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-127"><a href="#cb20-127" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4) Combine all Manhattan-start trips for this month</span></span>
<span id="cb20-128"><a href="#cb20-128" aria-hidden="true" tabindex="-1"></a>  month_all <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(month_list, <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-129"><a href="#cb20-129" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-130"><a href="#cb20-130" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5) Clean up temp files</span></span>
<span id="cb20-131"><a href="#cb20-131" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(tmpdir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-132"><a href="#cb20-132" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb20-133"><a href="#cb20-133" aria-hidden="true" tabindex="-1"></a>  month_all</span>
<span id="cb20-134"><a href="#cb20-134" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-135"><a href="#cb20-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-136"><a href="#cb20-136" aria-hidden="true" tabindex="-1"></a>all_months_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(months))</span>
<span id="cb20-137"><a href="#cb20-137" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(months)) {</span>
<span id="cb20-138"><a href="#cb20-138" aria-hidden="true" tabindex="-1"></a>  all_months_list[[i]] <span class="ot">&lt;-</span> <span class="fu">process_month_manhattan</span>(months[i])</span>
<span id="cb20-139"><a href="#cb20-139" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb20-140"><a href="#cb20-140" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-141"><a href="#cb20-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-142"><a href="#cb20-142" aria-hidden="true" tabindex="-1"></a>citibike_manhattan_all <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(all_months_list, <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb20-143"><a href="#cb20-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-144"><a href="#cb20-144" aria-hidden="true" tabindex="-1"></a>citibike_out <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"citibike_manhattan_all_202410_202510.rds"</span>)</span>
<span id="cb20-145"><a href="#cb20-145" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(citibike_manhattan_all, citibike_out)</span>
<span id="cb20-146"><a href="#cb20-146" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Saved Manhattan-start trips to: "</span>, citibike_out)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Before, we join our two datasets, we must first clean our raw data directory as there are many files we no longer have any use for.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find only .zip files (non-recursive)</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>zip_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  raw_dir,</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.zip$"</span>,</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(zip_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Deleting ZIP files in "</span>, raw_dir)</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(zip_files, <span class="at">force =</span> <span class="cn">TRUE</span>)</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Deleted "</span>, <span class="fu">length</span>(zip_files), <span class="st">" ZIP files."</span>)</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No ZIP files found in "</span>, raw_dir)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Deleting ZIP files in data/raw</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Deleted 13 ZIP files.</code></pre>
</div>
</div>
</section>
</section>
<section id="join-bike-and-weather-data" class="level2">
<h2 class="anchored" data-anchor-id="join-bike-and-weather-data">4. Join Bike and Weather Data</h2>
<p>To start, we have to load the cleaned Manhattan Citi Bike trips file and the daily weather file that we created earlier.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Loading Citi Bike and weather data</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Loading Citi Bike and weather data</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Load data</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>citibike_path <span class="ot">&lt;-</span> <span class="st">"data/processed/citibike_manhattan_all_202410_202510.rds"</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>weather_path  <span class="ot">&lt;-</span> <span class="st">"data/processed/weather_daily_10036_202410_202510.rds"</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(citibike_path)) <span class="fu">stop</span>(<span class="st">"Missing Citi Bike file"</span>)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(weather_path)) <span class="fu">stop</span>(<span class="st">"Missing weather file"</span>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>citibike <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(citibike_path)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>daily_weather <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(weather_path)</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(citibike)</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(daily_weather)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Citi Bike data is trip-level (many rows per day), so we first collapse it into one row per day by counting trips.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Building daily Citi Bike trip counts</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Building daily Citi Bike trip counts</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Build daily trips</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>citibike[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(started_at)]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>daily_trips <span class="ot">&lt;-</span> citibike[, .(<span class="at">n_trips =</span> .N), by <span class="ot">=</span> .(date)]</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>daily_trips <span class="ot">&lt;-</span> daily_trips[date <span class="sc">&gt;=</span> <span class="st">"2024-10-01"</span> <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="st">"2025-10-31"</span>]</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(daily_trips, date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Now both datasets are daily, so we merge them on date.<br>
<code>all.x = TRUE</code> keeps all days with Citi Bike trips, even if weather is missing.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Merging Citi Bike daily counts with weather</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Merging Citi Bike daily counts with weather</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Merge trips + weather</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  daily_trips,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  daily_weather,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"date"</span>,</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">all.x =</span> <span class="cn">TRUE</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="eda-summary-check" class="level3">
<h3 class="anchored" data-anchor-id="eda-summary-check">EDA: Summary Check</h3>
<p>Before making any plots or models, we must first check that the data looks correct. This step confirms that there is one row per day, that the dates cover the expected time period, and that ridership, temperature, and precipitation values fall within reasonable ranges. Doing this helps ensure that later results are based on real patterns in the data and not on data errors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows (days):"</span>, <span class="fu">nrow</span>(daily), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Rows (days): 396 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date range :"</span>, <span class="fu">min</span>(daily<span class="sc">$</span>date, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"to"</span>, <span class="fu">max</span>(daily<span class="sc">$</span>date, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Date range : 19997 to 20392 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dup_days <span class="ot">&lt;-</span> daily[, .N, by <span class="ot">=</span> date][N <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(dup_days) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dup_days)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"EDA check failed: duplicated dates found in daily panel."</span>)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EDA check: OK — one row per day.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>EDA check: OK — one row per day.</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(daily[, .(n_trips, temp_mean_F, precip_in)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    n_trips        temp_mean_F      precip_in      
 Min.   : 12867   Min.   :10.20   Min.   :0.00000  
 1st Qu.: 57070   1st Qu.:42.17   1st Qu.:0.00000  
 Median : 87231   Median :56.90   Median :0.00000  
 Mean   : 81711   Mean   :55.04   Mean   :0.11684  
 3rd Qu.:106908   3rd Qu.:68.95   3rd Qu.:0.09275  
 Max.   :130114   Max.   :94.30   Max.   :1.84600  </code></pre>
</div>
</div>
<ul>
<li>The dataset contains 396 days with exactly one observation per day, confirming that the daily aggregation is correct</li>
</ul>
<!-- -->
<ul>
<li>Daily ridership varies widely, from about 13,000 to 130,000 trips, showing that demand changes a lot from day to day</li>
</ul>
<!-- -->
<ul>
<li>Temperature covers a large range (about 10°F to 94°F) and changes smoothly across the year, suggesting it strongly affects ridership</li>
</ul>
</section>
<section id="eda-outlier-check" class="level3">
<h3 class="anchored" data-anchor-id="eda-outlier-check">EDA: Outlier Check</h3>
<p>To check whether very high ridership days are caused by data problems or by real rider behavior, we look at the weather on those highest-demand days.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead of deleting extremes, we inspect whether low/high ridership days align with extreme weather</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>low5  <span class="ot">&lt;-</span> daily[<span class="fu">order</span>(n_trips)][<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,  .(date, n_trips, temp_mean_F, precip_in)]</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>high5 <span class="ot">&lt;-</span> daily[<span class="fu">order</span>(<span class="sc">-</span>n_trips)][<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, .(date, n_trips, temp_mean_F, precip_in)]</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Lowest 5 ridership days:</span><span class="sc">\n</span><span class="st">"</span>);  low5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Lowest 5 ridership days:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         date n_trips temp_mean_F precip_in
       &lt;Date&gt;   &lt;int&gt;       &lt;num&gt;     &lt;num&gt;
1: 2024-12-25   12867        26.0     0.000
2: 2024-12-28   15233        39.0     0.220
3: 2024-11-28   15629        43.8     0.516
4: 2025-02-16   17315        36.8     0.846
5: 2024-12-22   19140        14.7     0.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Highest 5 ridership days:</span><span class="sc">\n</span><span class="st">"</span>); high5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Highest 5 ridership days:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>         date n_trips temp_mean_F precip_in
       &lt;Date&gt;   &lt;int&gt;       &lt;num&gt;     &lt;num&gt;
1: 2025-09-11  130114        69.5     0.000
2: 2025-09-18  129175        71.5     0.004
3: 2025-08-16  127586        77.8     0.193
4: 2025-09-12  127146        69.4     0.000
5: 2025-09-19  126768        72.2     0.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple rule-of-thumb flags</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>daily[, flag_low_trips <span class="sc">:</span><span class="er">=</span> n_trips <span class="sc">&lt;</span> <span class="fu">quantile</span>(n_trips, <span class="fl">0.01</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>daily[, flag_high_trips <span class="sc">:</span><span class="er">=</span> n_trips <span class="sc">&gt;</span> <span class="fu">quantile</span>(n_trips, <span class="fl">0.99</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>daily[flag_low_trips <span class="sc">==</span> <span class="cn">TRUE</span>,  .(<span class="at">n_days =</span> .N,</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_temp =</span> <span class="fu">mean</span>(temp_mean_F, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_prec =</span> <span class="fu">mean</span>(precip_in, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))] <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   n_days avg_temp avg_prec
    &lt;int&gt;    &lt;num&gt;    &lt;num&gt;
1:      4     36.4   0.3955</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>daily[flag_high_trips <span class="sc">==</span> <span class="cn">TRUE</span>, .(<span class="at">n_days =</span> .N,</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_temp =</span> <span class="fu">mean</span>(temp_mean_F, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_prec =</span> <span class="fu">mean</span>(precip_in, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))] <span class="sc">|&gt;</span> <span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   n_days avg_temp avg_prec
    &lt;int&gt;    &lt;num&gt;    &lt;num&gt;
1:      4    72.05  0.04925</code></pre>
</div>
</div>
<ul>
<li>There are 4 extremely high-ridership days in the dataset</li>
</ul>
<!-- -->
<ul>
<li><p>These days have an average temperature of about 72°F, which is comfortable for biking</p></li>
<li><p>Average precipitation is very low (~0.05 inches), indicating mostly dry conditions</p></li>
</ul>
<!-- -->
<ul>
<li>These weather patterns are realistic and favorable, suggesting the high ridership reflects true behavior, not data errors</li>
</ul>
</section>
<section id="eda-precipitation-threshold" class="level3">
<h3 class="anchored" data-anchor-id="eda-precipitation-threshold">EDA: Precipitation Threshold</h3>
<p>Before studying how rain affects ridership, we first look at how often each rain level appears in the data given certain thresholds.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># precipitation likely acts via thresholds, not smoothly</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>daily[, rain_cat <span class="sc">:</span><span class="er">=</span> <span class="fu">fifelse</span>(</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.na</span>(precip_in), <span class="cn">NA_character_</span>,</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fifelse</span>(precip_in <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"None"</span>,</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fifelse</span>(precip_in <span class="sc">&lt;=</span> <span class="fl">0.10</span>, <span class="st">"Light"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fifelse</span>(precip_in <span class="sc">&lt;=</span> <span class="fl">0.30</span>, <span class="st">"Moderate"</span>, <span class="st">"Heavy"</span>)</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>daily[, rain_cat <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(rain_cat, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"None"</span>,<span class="st">"Light"</span>,<span class="st">"Moderate"</span>,<span class="st">"Heavy"</span>))]</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of days by category</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>daily[, .N, by <span class="ot">=</span> rain_cat][<span class="fu">order</span>(rain_cat)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>   rain_cat     N
     &lt;fctr&gt; &lt;int&gt;
1:     None   219
2:    Light    79
3: Moderate    48
4:    Heavy    50</code></pre>
</div>
</div>
<ul>
<li><p>“None” accounts for more than half of all days</p></li>
<li><p>Precipitation’s predictive value comes from a small subset of days, not from day-to-day variation</p></li>
<li><p>Because precipitation only influences ridership on a limited number of days, its overall importance can appear smaller in aggregate models</p></li>
</ul>
<p>This saves the final day-level dataset that will be used as input for the graphs/models.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"shiny"</span>,     <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Saving combined daily panel</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Saving combined daily panel</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Save merged panel</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>panel_path <span class="ot">&lt;-</span> <span class="st">"data/processed/daily_trips_weather_202410_202510.rds"</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(daily, panel_path)</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Saved daily panel to:"</span>, panel_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Saved daily panel to: data/processed/daily_trips_weather_202410_202510.rds </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Save merged panel for shiny deployment</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>panel_path <span class="ot">&lt;-</span> <span class="st">"shiny/daily_trips_weather_202410_202510.rds"</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(daily, panel_path)</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Saved daily panel to:"</span>, panel_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Saved daily panel to: shiny/daily_trips_weather_202410_202510.rds </code></pre>
</div>
</div>
</section>
</section>
<section id="plot-data" class="level2">
<h2 class="anchored" data-anchor-id="plot-data">5. Plot Data</h2>
<p>Now that we’ve joined the Citi Bike and weather data into one daily dataset, we can move on to the visualization portion.</p>
<p>We will be creating two plots that directly answer our weather question:</p>
<p><strong>(1)</strong> a scatterplot of daily trips versus temperature with a <strong>GAM smooth</strong> to capture any non-linear relationship, and <strong>(2)</strong> a boxplot comparing daily trip volume across <strong>rain intensity categories</strong> to show how precipitation shifts ridership distributions.</p>
<p>To access these plots, please use the interactive dashboard below:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Interactive Dashboard</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">iframe</span>(</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">src =</span> <span class="st">"https://citibikenyc.shinyapps.io/appTemp/"</span>,</span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">style =</span> <span class="st">"width:100%; height:900px; border:0;"</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<iframe src="https://citibikenyc.shinyapps.io/appTemp/" style="width:100%; height:900px; border:0;"></iframe>
</div>
</div>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">6. Results</h2>
<section id="what-the-precipitation-figure-shows" class="level3">
<h3 class="anchored" data-anchor-id="what-the-precipitation-figure-shows">What the precipitation figure shows</h3>
<p>Starting with the rain boxplot, we see that for days with no rain, the median is around 92,000–95,000 trips. On days with light rain, the median is similar or slightly higher, indicating that very small amounts of rain do not meaningfully deter rider. It’s also worth noting that there are also far more days without rain than lightly rainy days. As such, light rain days are more likely to coincide with favorable conditions such as warmer temperatures.</p>
<p>The effect becomes clear once rain reaches moderate levels. When precipitation increases from none to moderate, the median daily trip count falls by roughly 10,000 trips, dropping to about 83,000–85,000 trips.</p>
<p>On days with heavy rain, the median drops to roughly 55,000 trips. That means heavy rain is associated with about 40,000 fewer trips in a single day compared to dry conditions.</p>
</section>
<section id="what-the-temperature-figure-shows" class="level3">
<h3 class="anchored" data-anchor-id="what-the-temperature-figure-shows">What the temperature figure shows</h3>
<p>The temperature plot tells the same story in a different way. On cold days (around 20–30°F), daily ridership usually falls between 30,000 and 50,000 trips. As temperatures rise into the 60s and low 70s, daily trips increase to over 105,000–110,000.</p>
<p>That is a swing of more than 60,000 trips per day across the temperature range. The smooth line also shows that ridership stops increasing once temperatures get very hot (above about 75–80°F), leveling off near 100,000 trips. This suggests that warm weather encourages biking up to a comfortable range, but extreme heat does not continue to increase usage.</p>
</section>
<section id="putting-temperature-and-precipitation-together" class="level3">
<h3 class="anchored" data-anchor-id="putting-temperature-and-precipitation-together">Putting temperature and precipitation together</h3>
<p>Taken together, the figures show that temperature and precipitation work in different but complementary ways. Temperature determines how high ridership can go, while precipitation determines how far below that level demand falls. On warm, dry days, ridership regularly exceeds 100,000 trips. On cold or rainy days, daily usage can fall to 50,000 trips or less.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Refer to the LOCO table in the group summary report.
</div>
</div>
<div class="callout-body-container callout-body">

</div>
</div>
<p>To conclude, weather causes very large swings in daily Citi Bike usage. From the figures, we see that changes in temperature and rain can reduce or increase daily ridership by 10,000 trips on moderate days and by more than 60,000 trips when comparing cold or rainy days to warm, dry ones. No other factor in the analysis causes changes anywhere near this large.</p>
<p>Because weather explains such big day-to-day differences, the model relies heavily on it to make accurate predictions. When we remove weather variables from the model, the model loses this key information. As a result, its predictions become much worse: the average prediction error increases by 2,145 trips per day, and the model’s ability to explain variation in ridership drops by 0.186 in R².</p>
<p>This drop in performance is the largest observed when removing any single factor. In simple terms, once the model no longer knows whether a day is warm, cold, dry, or rainy, it struggles to explain why ridership might be around 100,000 trips on one day but closer to 50,000 trips on another. That is why weather emerges as the most important factor in the LOCO analysis.</p>
</section>
</section>
<section id="further-analysis-temperature-vs.-precipitation" class="level2">
<h2 class="anchored" data-anchor-id="further-analysis-temperature-vs.-precipitation">7. Further Analysis: Temperature vs.&nbsp;Precipitation</h2>
<p>To assess their relative impact on weather, we will be applying a leave-one-covariate-out (LOCO) approach that compare the predictive contributions of temperature and precipitation. In this analysis, we start with a model that includes both weather variables (temperature and precipitation), then remove one variable at a time and observe how much the model’s performance changes. If removing a variable causes the model’s accuracy to worsen substantially, that variable is considered more important for predicting daily ridership.</p>
<p>We evaluate model performance using two standard metrics:</p>
<ul>
<li><p>RMSE (Root Mean Squared Error) measures the typical size of the model’s prediction error, expressed in number of trips per day. A lower RMSE means the model’s predictions are closer to the actual observed ridership.</p></li>
<li><p>R² (R-squared) measures how much of the day-to-day variation in Citi Bike ridership the model can explain. Higher R² values indicate that the model captures more of the underlying pattern in the data.</p></li>
</ul>
<section id="load-datasets" class="level3">
<h3 class="anchored" data-anchor-id="load-datasets">1. Load Datasets</h3>
<p>We load the processed Manhattan Citi Bike trip data and the daily weather data, then convert both into <code>data.table</code> objects for efficient data manipulation. All date fields are standardized to ensure the two datasets can be merged accurately at the daily level.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>trips <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/processed/citibike_manhattan_all_202410_202510.rds"</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>wx    <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/processed/weather_daily_10036_202410_202510.rds"</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(trips)</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(wx)</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(trips<span class="sc">$</span>started_at, <span class="st">"POSIXct"</span>)) {</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>  trips[, started_at <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(started_at, <span class="at">tz =</span> <span class="st">"America/New_York"</span>)]</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>trips[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(started_at)]</span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>wx[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="define-the-outcome-variable" class="level3">
<h3 class="anchored" data-anchor-id="define-the-outcome-variable">2. Define the outcome variable</h3>
<p>Because weather conditions vary by day, we aggregate trip-level data into a daily outcome variable, <strong><code>n_trips</code></strong>, which represents the total number of Citi Bike trips taken on each date. This aligns the outcome with the temporal scale of the weather data.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>y_daily <span class="ot">&lt;-</span> trips[, .(<span class="at">n_trips =</span> .N), by <span class="ot">=</span> date]</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(y_daily, date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="select-weather-predictors" class="level3">
<h3 class="anchored" data-anchor-id="select-weather-predictors">3. Select weather predictors</h3>
<p>From the weather dataset, we retain only two variables:</p>
<ul>
<li><p><strong><code>temp_mean_F</code></strong>: daily average temperature (°F)</p></li>
<li><p><strong><code>precip_in</code></strong>: total daily precipitation (inches)</p></li>
</ul>
<p>Limiting predictors to just these two variables makes sure that the analysis focuses exclusively on comparing the effects of temperature and precipitation, without introducing additional confounding factors.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>wx_daily <span class="ot">&lt;-</span> wx[, .(date, temp_mean_F, precip_in)]</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(wx_daily, date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="create-the-modeling-dataset" class="level3">
<h3 class="anchored" data-anchor-id="create-the-modeling-dataset">4. Create the modeling dataset</h3>
<p>We merge the daily trip totals with the daily weather variables by date to form a single modeling dataset. Any days with missing values are removed so that all models are trained and evaluated using the same complete set of observations.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(y_daily, wx_daily, <span class="at">by =</span> <span class="st">"date"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt[<span class="sc">!</span><span class="fu">is.na</span>(n_trips) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_mean_F) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(precip_in)]</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(dt, date)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="use-a-traintest-split" class="level3">
<h3 class="anchored" data-anchor-id="use-a-traintest-split">5. Use a train/test split</h3>
<p>To prevent information from the future influencing model training, we split the data chronologically. The first 80% of days are used for training, while the remaining 20% are reserved for testing. This time-safe split reflects a realistic forecasting setting.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>n   <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt)</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>cut <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fl">0.8</span> <span class="sc">*</span> n)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>train_dt <span class="ot">&lt;-</span> dt[<span class="dv">1</span><span class="sc">:</span>cut]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>test_dt  <span class="ot">&lt;-</span> dt[(cut<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="fit-and-evaluate-models" class="level3">
<h3 class="anchored" data-anchor-id="fit-and-evaluate-models">6. Fit and evaluate models</h3>
<p>We define a helper function that fits a <strong>random forest model</strong> using the <code>ranger</code> package and evaluates its performance on the test set. Model performance is assessed using two metrics:</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>score_model <span class="ot">&lt;-</span> <span class="cf">function</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="fu">character</span>()) {</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>  x_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(train_dt), <span class="fu">c</span>(<span class="st">"date"</span>,<span class="st">"n_trips"</span>, drop_cols))</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"n_trips ~"</span>, <span class="fu">paste</span>(x_cols, <span class="at">collapse =</span> <span class="st">" + "</span>))),</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> train_dt,</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">num.trees =</span> <span class="dv">500</span>,</span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">length</span>(x_cols)))),</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> <span class="dv">10</span>,</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">num.threads =</span> <span class="fu">max</span>(<span class="dv">1</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">data =</span> test_dt)<span class="sc">$</span>predictions</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_dt<span class="sc">$</span>n_trips <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>  r2   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>((test_dt<span class="sc">$</span>n_trips <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>((test_dt<span class="sc">$</span>n_trips <span class="sc">-</span> <span class="fu">mean</span>(test_dt<span class="sc">$</span>n_trips))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">rmse =</span> rmse, <span class="at">r2 =</span> r2)</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="baseline-model" class="level3">
<h3 class="anchored" data-anchor-id="baseline-model">7. Baseline model</h3>
<p>We first fit a baseline random forest model that includes both temperature and precipitation. The RMSE and R² from this full model serve as reference benchmarks for evaluating the impact of removing each weather variable in the LOCO analysis.</p>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> <span class="fu">score_model</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="fu">character</span>())</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Full model (Temp + Precip)</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Full model (Temp + Precip)</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"RMSE:"</span>, <span class="fu">round</span>(base<span class="sc">$</span>rmse, <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>RMSE: 15280.1 </code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"R^2 :"</span>, <span class="fu">round</span>(base<span class="sc">$</span>r2, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>R^2 : 0.326 </code></pre>
</div>
</div>
</section>
<section id="loco-temperature-vs.-precipitation" class="level3">
<h3 class="anchored" data-anchor-id="loco-temperature-vs.-precipitation">8. LOCO: Temperature vs.&nbsp;Precipitation</h3>
<p>We apply the leave-one-covariate-out (LOCO) procedure by refitting the model twice:</p>
<ul>
<li><p><strong>Remove temperature:</strong> the model is trained using precipitation only.</p></li>
<li><p><strong>Remove precipitation:</strong> the model is trained using temperature only</p></li>
</ul>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>loco <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">list</span>(</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">score_model</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="st">"temp_mean_F"</span>)</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">component   =</span> <span class="st">"Temperature"</span>,</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">rmse        =</span> res<span class="sc">$</span>rmse,</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>      <span class="at">r2          =</span> res<span class="sc">$</span>r2</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">score_model</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="st">"precip_in"</span>)</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">component   =</span> <span class="st">"Precipitation"</span>,</span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">rmse        =</span> res<span class="sc">$</span>rmse,</span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">r2          =</span> res<span class="sc">$</span>r2</span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>), <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute deltas vs full model</span></span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>loco[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_rmse =</span> rmse <span class="sc">-</span> base<span class="sc">$</span>rmse,</span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_r2   =</span> r2   <span class="sc">-</span> base<span class="sc">$</span>r2</span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(loco, <span class="sc">-</span>delta_rmse)</span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>loco[, rank <span class="sc">:</span><span class="er">=</span> <span class="fu">frank</span>(<span class="sc">-</span>delta_rmse, <span class="at">ties.method =</span> <span class="st">"first"</span>)]</span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a><span class="fu">setcolorder</span>(loco, <span class="fu">c</span>(<span class="st">"rank"</span>,<span class="st">"component"</span>,<span class="st">"rmse"</span>,<span class="st">"r2"</span>,<span class="st">"delta_rmse"</span>,<span class="st">"delta_r2"</span>))</span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(loco)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>    rank     component     rmse         r2 delta_rmse   delta_r2
   &lt;int&gt;        &lt;char&gt;    &lt;num&gt;      &lt;num&gt;      &lt;num&gt;      &lt;num&gt;
1:     1   Temperature 29189.99 -1.4587822  13909.885 -1.7850229
2:     2 Precipitation 21624.98 -0.3494719   6344.881 -0.6757125</code></pre>
</div>
</div>
</section>
<section id="interpreting-the-results" class="level3">
<h3 class="anchored" data-anchor-id="interpreting-the-results">9. Interpreting the results</h3>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>loco <span class="sc">|&gt;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">rank =</span> <span class="st">"Rank"</span>,</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">component =</span> <span class="st">"Dropped"</span>,</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmse =</span> <span class="st">"RMSE (LOCO)"</span>,</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">r2 =</span> <span class="st">"R² (LOCO)"</span>,</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_rmse =</span> <span class="st">"Δ RMSE vs Full"</span>,</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_r2 =</span> <span class="st">"Δ R² vs Full"</span></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(rmse, delta_rmse), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(r2, delta_r2), <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"LOCO Weather Importance: Temperature vs Precipitation"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div id="itkedezuqj" style="padding-left:0px;padding-right:0px;padding-top:10px;padding-bottom:10px;overflow-x:auto;overflow-y:auto;width:auto;height:auto;">
<style>#itkedezuqj table {
  font-family: system-ui, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

#itkedezuqj thead, #itkedezuqj tbody, #itkedezuqj tfoot, #itkedezuqj tr, #itkedezuqj td, #itkedezuqj th {
  border-style: none;
}

#itkedezuqj p {
  margin: 0;
  padding: 0;
}

#itkedezuqj .gt_table {
  display: table;
  border-collapse: collapse;
  line-height: normal;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#itkedezuqj .gt_caption {
  padding-top: 4px;
  padding-bottom: 4px;
}

#itkedezuqj .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#itkedezuqj .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 3px;
  padding-bottom: 5px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#itkedezuqj .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#itkedezuqj .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#itkedezuqj .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#itkedezuqj .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#itkedezuqj .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#itkedezuqj .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#itkedezuqj .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#itkedezuqj .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 5px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#itkedezuqj .gt_spanner_row {
  border-bottom-style: hidden;
}

#itkedezuqj .gt_group_heading {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  text-align: left;
}

#itkedezuqj .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#itkedezuqj .gt_from_md > :first-child {
  margin-top: 0;
}

#itkedezuqj .gt_from_md > :last-child {
  margin-bottom: 0;
}

#itkedezuqj .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#itkedezuqj .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
}

#itkedezuqj .gt_stub_row_group {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 5px;
  padding-right: 5px;
  vertical-align: top;
}

#itkedezuqj .gt_row_group_first td {
  border-top-width: 2px;
}

#itkedezuqj .gt_row_group_first th {
  border-top-width: 2px;
}

#itkedezuqj .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#itkedezuqj .gt_first_summary_row {
  border-top-style: solid;
  border-top-color: #D3D3D3;
}

#itkedezuqj .gt_first_summary_row.thick {
  border-top-width: 2px;
}

#itkedezuqj .gt_last_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#itkedezuqj .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#itkedezuqj .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#itkedezuqj .gt_last_grand_summary_row_top {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-bottom-style: double;
  border-bottom-width: 6px;
  border-bottom-color: #D3D3D3;
}

#itkedezuqj .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#itkedezuqj .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#itkedezuqj .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#itkedezuqj .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#itkedezuqj .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#itkedezuqj .gt_sourcenote {
  font-size: 90%;
  padding-top: 4px;
  padding-bottom: 4px;
  padding-left: 5px;
  padding-right: 5px;
}

#itkedezuqj .gt_left {
  text-align: left;
}

#itkedezuqj .gt_center {
  text-align: center;
}

#itkedezuqj .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#itkedezuqj .gt_font_normal {
  font-weight: normal;
}

#itkedezuqj .gt_font_bold {
  font-weight: bold;
}

#itkedezuqj .gt_font_italic {
  font-style: italic;
}

#itkedezuqj .gt_super {
  font-size: 65%;
}

#itkedezuqj .gt_footnote_marks {
  font-size: 75%;
  vertical-align: 0.4em;
  position: initial;
}

#itkedezuqj .gt_asterisk {
  font-size: 100%;
  vertical-align: 0;
}

#itkedezuqj .gt_indent_1 {
  text-indent: 5px;
}

#itkedezuqj .gt_indent_2 {
  text-indent: 10px;
}

#itkedezuqj .gt_indent_3 {
  text-indent: 15px;
}

#itkedezuqj .gt_indent_4 {
  text-indent: 20px;
}

#itkedezuqj .gt_indent_5 {
  text-indent: 25px;
}

#itkedezuqj .katex-display {
  display: inline-flex !important;
  margin-bottom: 0.75em !important;
}

#itkedezuqj div.Reactable > div.rt-table > div.rt-thead > div.rt-tr.rt-tr-group-header > div.rt-th-group:after {
  height: 0px !important;
}
</style>

<table class="gt_table caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-quarto-disable-processing="false" data-quarto-bootstrap="false">
<thead>
<tr class="gt_heading header">
<th colspan="6" class="gt_heading gt_title gt_font_normal gt_bottom_border">LOCO Weather Importance: Temperature vs Precipitation</th>
</tr>
<tr class="gt_col_headings even">
<th id="rank" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Rank</th>
<th id="component" class="gt_col_heading gt_columns_bottom_border gt_left" data-quarto-table-cell-role="th" scope="col">Dropped</th>
<th id="rmse" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">RMSE (LOCO)</th>
<th id="r2" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">R² (LOCO)</th>
<th id="delta_rmse" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Δ RMSE vs Full</th>
<th id="delta_r2" class="gt_col_heading gt_columns_bottom_border gt_right" data-quarto-table-cell-role="th" scope="col">Δ R² vs Full</th>
</tr>
</thead>
<tbody class="gt_table_body">
<tr class="odd">
<td class="gt_row gt_right" headers="rank">1</td>
<td class="gt_row gt_left" headers="component">Temperature</td>
<td class="gt_row gt_right" headers="rmse">29,190</td>
<td class="gt_row gt_right" headers="r2">−1.459</td>
<td class="gt_row gt_right" headers="delta_rmse">13,910</td>
<td class="gt_row gt_right" headers="delta_r2">−1.785</td>
</tr>
<tr class="even">
<td class="gt_row gt_right" headers="rank">2</td>
<td class="gt_row gt_left" headers="component">Precipitation</td>
<td class="gt_row gt_right" headers="rmse">21,625</td>
<td class="gt_row gt_right" headers="r2">−0.349</td>
<td class="gt_row gt_right" headers="delta_rmse">6,345</td>
<td class="gt_row gt_right" headers="delta_r2">−0.676</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>The LOCO analysis shows that between the two variables, temperature is the stronger predictor of daily Citi Bike ridership compared to precipitation. When temperature is removed from the model, prediction accuracy declines substantially: the typical prediction error increases by roughly 14,000 trips per day, and the model’s R² becomes strongly negative. This indicates that the model without temperature performs much worse than simply predicting the average number of daily trips, highlighting how essential temperature is for capturing day-to-day variation in ridership.</p>
<p>In contrast, removing precipitation also reduces model performance, but to a lesser degree. The increase in prediction error is about 6,300 trips per day, and the drop in R² is smaller than when temperature is removed. This suggests that precipitation provides useful information, particularly for suppressing ridership on rainy days, but it does not explain as much overall variation as temperature.</p>
<p>Some limitations to note are that the effect of precipitation may be understated in this analysis because rainfall is sporadic and short-lived, rather than a consistent condition throughout the day. Aggregating precipitation to the daily level can mask important within-day variation, such as brief rain events that strongly suppress ridership during specific hours but do not persist long enough to substantially affect the daily total.</p>
<p>An hourly analysis would better capture these short-term behavioral responses to rain. However, due to memory and computational constraints associated with processing the full trip-level dataset at an hourly resolution, we default to a daily aggregation. As a result, the LOCO comparison likely favors temperature due to exerting a more persistent, day-long influence, while underrepresenting the true impact of precipitation.</p>


<!-- -->

</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb75" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Effects of Temperature and Precipitation on Bike Ridership"</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span><span class="co"> </span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html: </span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="co">    page-layout: full</span></span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="co">    code-tools: true</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="co">    code-fold: true</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="co">    code-summary: "Code"</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a><span class="an">author:</span><span class="co"> Christopher Tan</span></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="an">publish-date:</span><span class="co"> 2025-12-18</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="an">execute:</span><span class="co"> </span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="co">  freeze: auto</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="fu">## 1. Overview</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>Citi Bike demand can change substantially from one day to the next, and weather is one of the most direct reasons why. Unlike long recreational rides, many Citi Bike trips in Manhattan are short, purpose driven trips such as commutes to work, quick errands, or first and last mile connections to the subway. Because these trips are often discretionary at the margin, riders continuously weigh the convenience of biking against comfort and perceived safety.</span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>Temperature plays a key role in this decision making process. Warmer days generally lower the physical and mental barrier to riding, making biking feel easier and more pleasant, which can lead to higher overall trip volume. In contrast, colder days can discourage riding due to discomfort. Precipitation adds another layer of friction by reducing comfort and increasing safety concerns such as slippery roads and reduced visibility, leading some riders to choose alternative modes of transportation.</span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>Together, these patterns suggest that daily weather conditions may systematically influence Citi Bike usage. To quantify this relationship and move beyond intuition, this analysis focuses on the following question:</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; *How do daily temperature and precipitation levels affect Citi Bike trip volume in Manhattan?*</span></span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## 2. Data Preparation</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a><span class="fu">### Install packages</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>First, we must load the following:</span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`data.table`</span> for fast CSV reading and big-data manipulation</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`sf`</span> for spatial operations (point-in-polygon)</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`utils`</span> for downloads</span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`httr`</span> + <span class="in">`jsonlite`</span> for calling the weather API and parsing JSON</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`htmltools`</span> for the iFrame embed</span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`gt`</span> for creating clean tables in Quarto</span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`ranger`</span> for fitting fast random forest models</span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(sf)</span>
<span id="cb75-51"><a href="#cb75-51" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(utils)</span>
<span id="cb75-52"><a href="#cb75-52" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb75-53"><a href="#cb75-53" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(jsonlite)</span>
<span id="cb75-54"><a href="#cb75-54" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(htmltools)</span>
<span id="cb75-55"><a href="#cb75-55" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(gt)</span>
<span id="cb75-56"><a href="#cb75-56" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ranger)</span>
<span id="cb75-57"><a href="#cb75-57" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-58"><a href="#cb75-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-59"><a href="#cb75-59" aria-hidden="true" tabindex="-1"></a><span class="fu">### Directories</span></span>
<span id="cb75-60"><a href="#cb75-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-63"><a href="#cb75-63" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-64"><a href="#cb75-64" aria-hidden="true" tabindex="-1"></a>raw_dir <span class="ot">&lt;-</span> <span class="st">"data/raw"</span>          <span class="co"># zipped tripdata</span></span>
<span id="cb75-65"><a href="#cb75-65" aria-hidden="true" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="st">"data/processed"</span>    <span class="co"># cleaned outputs</span></span>
<span id="cb75-66"><a href="#cb75-66" aria-hidden="true" tabindex="-1"></a>gis_dir <span class="ot">&lt;-</span> <span class="st">"data/gis"</span>          <span class="co"># borough shapefile</span></span>
<span id="cb75-67"><a href="#cb75-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-68"><a href="#cb75-68" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(raw_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-69"><a href="#cb75-69" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(out_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-70"><a href="#cb75-70" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(gis_dir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-71"><a href="#cb75-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-72"><a href="#cb75-72" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-73"><a href="#cb75-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-74"><a href="#cb75-74" aria-hidden="true" tabindex="-1"></a><span class="fu">### Download Settings</span></span>
<span id="cb75-75"><a href="#cb75-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-76"><a href="#cb75-76" aria-hidden="true" tabindex="-1"></a>Two stability tweaks for large downloads:</span>
<span id="cb75-77"><a href="#cb75-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-78"><a href="#cb75-78" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>longer timeout</span>
<span id="cb75-79"><a href="#cb75-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-80"><a href="#cb75-80" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`libcurl`</span> download method</span>
<span id="cb75-81"><a href="#cb75-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-84"><a href="#cb75-84" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-85"><a href="#cb75-85" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">download.file.method =</span> <span class="st">"libcurl"</span>)</span>
<span id="cb75-86"><a href="#cb75-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-87"><a href="#cb75-87" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-88"><a href="#cb75-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-89"><a href="#cb75-89" aria-hidden="true" tabindex="-1"></a><span class="fu">### Time Window</span></span>
<span id="cb75-90"><a href="#cb75-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-91"><a href="#cb75-91" aria-hidden="true" tabindex="-1"></a>Define the month labels Citi Bike uses (<span class="in">`YYYYMM`</span>) and the base URL.</span>
<span id="cb75-92"><a href="#cb75-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-95"><a href="#cb75-95" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-96"><a href="#cb75-96" aria-hidden="true" tabindex="-1"></a>months <span class="ot">&lt;-</span> <span class="fu">format</span>(</span>
<span id="cb75-97"><a href="#cb75-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">"2024-10-01"</span>), <span class="fu">as.Date</span>(<span class="st">"2025-10-01"</span>), <span class="at">by =</span> <span class="st">"month"</span>),</span>
<span id="cb75-98"><a href="#cb75-98" aria-hidden="true" tabindex="-1"></a>  <span class="st">"%Y%m"</span></span>
<span id="cb75-99"><a href="#cb75-99" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-100"><a href="#cb75-100" aria-hidden="true" tabindex="-1"></a>base_url <span class="ot">&lt;-</span> <span class="st">"https://s3.amazonaws.com/tripdata"</span></span>
<span id="cb75-101"><a href="#cb75-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-102"><a href="#cb75-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-103"><a href="#cb75-103" aria-hidden="true" tabindex="-1"></a><span class="fu">### Download Manhattan Polygon (GIS)</span></span>
<span id="cb75-104"><a href="#cb75-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-105"><a href="#cb75-105" aria-hidden="true" tabindex="-1"></a>We must download NYC borough boundaries, read them as an <span class="in">`sf`</span> object, convert to standard lat/lon (EPSG:4326), then extract **only Manhattan** as <span class="in">`manhattan_poly`</span>. That polygon is used later to filter trips.</span>
<span id="cb75-106"><a href="#cb75-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-109"><a href="#cb75-109" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-110"><a href="#cb75-110" aria-hidden="true" tabindex="-1"></a>borough_url <span class="ot">&lt;-</span> <span class="st">"https://www.nyc.gov/assets/planning/download/zip/data-maps/open-data/nybb_16a.zip"</span></span>
<span id="cb75-111"><a href="#cb75-111" aria-hidden="true" tabindex="-1"></a>borough_zip <span class="ot">&lt;-</span> <span class="fu">file.path</span>(gis_dir, <span class="st">"nyc_boroughs.zip"</span>)</span>
<span id="cb75-112"><a href="#cb75-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-113"><a href="#cb75-113" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(borough_zip)) {</span>
<span id="cb75-114"><a href="#cb75-114" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Downloading NYC borough boundaries shapefile..."</span>)</span>
<span id="cb75-115"><a href="#cb75-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">download.file</span>(borough_url, borough_zip, <span class="at">mode =</span> <span class="st">"wb"</span>)</span>
<span id="cb75-116"><a href="#cb75-116" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-117"><a href="#cb75-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-118"><a href="#cb75-118" aria-hidden="true" tabindex="-1"></a><span class="fu">unzip</span>(borough_zip, <span class="at">exdir =</span> gis_dir)</span>
<span id="cb75-119"><a href="#cb75-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-120"><a href="#cb75-120" aria-hidden="true" tabindex="-1"></a>shp_file <span class="ot">&lt;-</span> <span class="fu">list.files</span>(gis_dir, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.shp$"</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span>]</span>
<span id="cb75-121"><a href="#cb75-121" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.na</span>(shp_file)) <span class="fu">stop</span>(<span class="st">"No .shp file found in "</span>, gis_dir, <span class="st">" after unzip."</span>)</span>
<span id="cb75-122"><a href="#cb75-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-123"><a href="#cb75-123" aria-hidden="true" tabindex="-1"></a>boroughs <span class="ot">&lt;-</span> <span class="fu">st_read</span>(shp_file, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-124"><a href="#cb75-124" aria-hidden="true" tabindex="-1"></a>boroughs <span class="ot">&lt;-</span> <span class="fu">st_transform</span>(boroughs, <span class="dv">4326</span>)</span>
<span id="cb75-125"><a href="#cb75-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-126"><a href="#cb75-126" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>(<span class="st">"BoroName"</span> <span class="sc">%in%</span> <span class="fu">names</span>(boroughs))) {</span>
<span id="cb75-127"><a href="#cb75-127" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Could not find a 'BoroName' column in borough shapefile."</span>)</span>
<span id="cb75-128"><a href="#cb75-128" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-129"><a href="#cb75-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-130"><a href="#cb75-130" aria-hidden="true" tabindex="-1"></a>manhattan_poly <span class="ot">&lt;-</span> boroughs[boroughs<span class="sc">$</span>BoroName <span class="sc">==</span> <span class="st">"Manhattan"</span>, ]</span>
<span id="cb75-131"><a href="#cb75-131" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(manhattan_poly) <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">stop</span>(<span class="st">"Manhattan polygon not found in boroughs shapefile."</span>)</span>
<span id="cb75-132"><a href="#cb75-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-133"><a href="#cb75-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-134"><a href="#cb75-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-135"><a href="#cb75-135" aria-hidden="true" tabindex="-1"></a><span class="fu">### Download from Open-Meteo</span></span>
<span id="cb75-136"><a href="#cb75-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-137"><a href="#cb75-137" aria-hidden="true" tabindex="-1"></a>Set location:</span>
<span id="cb75-138"><a href="#cb75-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-141"><a href="#cb75-141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-142"><a href="#cb75-142" aria-hidden="true" tabindex="-1"></a><span class="co"># used Midtown as our reference point</span></span>
<span id="cb75-143"><a href="#cb75-143" aria-hidden="true" tabindex="-1"></a>latitude  <span class="ot">&lt;-</span> <span class="fl">40.75493</span></span>
<span id="cb75-144"><a href="#cb75-144" aria-hidden="true" tabindex="-1"></a>longitude <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">73.98402</span></span>
<span id="cb75-145"><a href="#cb75-145" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-146"><a href="#cb75-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-147"><a href="#cb75-147" aria-hidden="true" tabindex="-1"></a>Query Open-Meteo for daily:</span>
<span id="cb75-148"><a href="#cb75-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-149"><a href="#cb75-149" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>mean temperature (<span class="in">`temperature_2m_mean`</span>)</span>
<span id="cb75-150"><a href="#cb75-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-151"><a href="#cb75-151" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>precipitation sum (<span class="in">`precipitation_sum`</span>)</span>
<span id="cb75-152"><a href="#cb75-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-155"><a href="#cb75-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-156"><a href="#cb75-156" aria-hidden="true" tabindex="-1"></a>get_monthly_weather <span class="ot">&lt;-</span> <span class="cf">function</span>(lat, lon, start_date, end_date, <span class="at">max_attempts =</span> <span class="dv">5</span>) {</span>
<span id="cb75-157"><a href="#cb75-157" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-158"><a href="#cb75-158" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Use archive endpoint for past dates (more appropriate for historical pulls)</span></span>
<span id="cb75-159"><a href="#cb75-159" aria-hidden="true" tabindex="-1"></a>  base_url <span class="ot">&lt;-</span> <span class="st">"https://api.open-meteo.com/v1/forecast"</span></span>
<span id="cb75-160"><a href="#cb75-160" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">as.Date</span>(start_date) <span class="sc">&lt;</span> <span class="fu">Sys.Date</span>()) {</span>
<span id="cb75-161"><a href="#cb75-161" aria-hidden="true" tabindex="-1"></a>    base_url <span class="ot">&lt;-</span> <span class="st">"https://archive-api.open-meteo.com/v1/archive"</span></span>
<span id="cb75-162"><a href="#cb75-162" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-163"><a href="#cb75-163" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-164"><a href="#cb75-164" aria-hidden="true" tabindex="-1"></a>  params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb75-165"><a href="#cb75-165" aria-hidden="true" tabindex="-1"></a>    <span class="at">latitude           =</span> lat,</span>
<span id="cb75-166"><a href="#cb75-166" aria-hidden="true" tabindex="-1"></a>    <span class="at">longitude          =</span> lon,</span>
<span id="cb75-167"><a href="#cb75-167" aria-hidden="true" tabindex="-1"></a>    <span class="at">start_date         =</span> start_date,</span>
<span id="cb75-168"><a href="#cb75-168" aria-hidden="true" tabindex="-1"></a>    <span class="at">end_date           =</span> end_date,</span>
<span id="cb75-169"><a href="#cb75-169" aria-hidden="true" tabindex="-1"></a>    <span class="at">daily              =</span> <span class="st">"temperature_2m_mean,precipitation_sum"</span>,</span>
<span id="cb75-170"><a href="#cb75-170" aria-hidden="true" tabindex="-1"></a>    <span class="at">temperature_unit   =</span> <span class="st">"fahrenheit"</span>,</span>
<span id="cb75-171"><a href="#cb75-171" aria-hidden="true" tabindex="-1"></a>    <span class="at">precipitation_unit =</span> <span class="st">"inch"</span>,</span>
<span id="cb75-172"><a href="#cb75-172" aria-hidden="true" tabindex="-1"></a>    <span class="at">timezone           =</span> <span class="st">"America/New_York"</span></span>
<span id="cb75-173"><a href="#cb75-173" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-174"><a href="#cb75-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-175"><a href="#cb75-175" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (attempt <span class="cf">in</span> <span class="fu">seq_len</span>(max_attempts)) {</span>
<span id="cb75-176"><a href="#cb75-176" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-177"><a href="#cb75-177" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Robust request: longer timeout + safe error handling</span></span>
<span id="cb75-178"><a href="#cb75-178" aria-hidden="true" tabindex="-1"></a>    resp <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>(</span>
<span id="cb75-179"><a href="#cb75-179" aria-hidden="true" tabindex="-1"></a>      <span class="fu">GET</span>(base_url, <span class="at">query =</span> params, <span class="fu">timeout</span>(<span class="dv">60</span>)),</span>
<span id="cb75-180"><a href="#cb75-180" aria-hidden="true" tabindex="-1"></a>      <span class="at">error =</span> <span class="cf">function</span>(e) e</span>
<span id="cb75-181"><a href="#cb75-181" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-182"><a href="#cb75-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-183"><a href="#cb75-183" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If the request failed (DNS/timeout/etc.), retry with backoff</span></span>
<span id="cb75-184"><a href="#cb75-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">inherits</span>(resp, <span class="st">"error"</span>)) {</span>
<span id="cb75-185"><a href="#cb75-185" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Weather request error (attempt "</span>, attempt, <span class="st">"): "</span>, resp<span class="sc">$</span>message)</span>
<span id="cb75-186"><a href="#cb75-186" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">2</span> <span class="sc">^</span> attempt)</span>
<span id="cb75-187"><a href="#cb75-187" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb75-188"><a href="#cb75-188" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-189"><a href="#cb75-189" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-190"><a href="#cb75-190" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If server returns non-200, retry (could be temporary)</span></span>
<span id="cb75-191"><a href="#cb75-191" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">status_code</span>(resp) <span class="sc">!=</span> <span class="dv">200</span>) {</span>
<span id="cb75-192"><a href="#cb75-192" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"Weather request failed (attempt "</span>, attempt, <span class="st">") status: "</span>,</span>
<span id="cb75-193"><a href="#cb75-193" aria-hidden="true" tabindex="-1"></a>              <span class="fu">status_code</span>(resp))</span>
<span id="cb75-194"><a href="#cb75-194" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">2</span> <span class="sc">^</span> attempt)</span>
<span id="cb75-195"><a href="#cb75-195" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb75-196"><a href="#cb75-196" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-197"><a href="#cb75-197" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-198"><a href="#cb75-198" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse JSON</span></span>
<span id="cb75-199"><a href="#cb75-199" aria-hidden="true" tabindex="-1"></a>    dat <span class="ot">&lt;-</span> <span class="fu">fromJSON</span>(<span class="fu">content</span>(resp, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>))</span>
<span id="cb75-200"><a href="#cb75-200" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-201"><a href="#cb75-201" aria-hidden="true" tabindex="-1"></a>    <span class="co"># If daily data is missing, retry</span></span>
<span id="cb75-202"><a href="#cb75-202" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">is.null</span>(dat<span class="sc">$</span>daily<span class="sc">$</span>time)) {</span>
<span id="cb75-203"><a href="#cb75-203" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"No daily data returned (attempt "</span>, attempt, <span class="st">") for "</span>,</span>
<span id="cb75-204"><a href="#cb75-204" aria-hidden="true" tabindex="-1"></a>              start_date, <span class="st">"–"</span>, end_date)</span>
<span id="cb75-205"><a href="#cb75-205" aria-hidden="true" tabindex="-1"></a>      <span class="fu">Sys.sleep</span>(<span class="dv">2</span> <span class="sc">^</span> attempt)</span>
<span id="cb75-206"><a href="#cb75-206" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb75-207"><a href="#cb75-207" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-208"><a href="#cb75-208" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-209"><a href="#cb75-209" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Success: return clean daily table</span></span>
<span id="cb75-210"><a href="#cb75-210" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(data.table<span class="sc">::</span><span class="fu">data.table</span>(</span>
<span id="cb75-211"><a href="#cb75-211" aria-hidden="true" tabindex="-1"></a>      <span class="at">date        =</span> <span class="fu">as.Date</span>(dat<span class="sc">$</span>daily<span class="sc">$</span>time),</span>
<span id="cb75-212"><a href="#cb75-212" aria-hidden="true" tabindex="-1"></a>      <span class="at">temp_mean_F =</span> dat<span class="sc">$</span>daily<span class="sc">$</span>temperature_2m_mean,</span>
<span id="cb75-213"><a href="#cb75-213" aria-hidden="true" tabindex="-1"></a>      <span class="at">precip_in   =</span> dat<span class="sc">$</span>daily<span class="sc">$</span>precipitation_sum</span>
<span id="cb75-214"><a href="#cb75-214" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb75-215"><a href="#cb75-215" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-216"><a href="#cb75-216" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-217"><a href="#cb75-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">warning</span>(<span class="st">"Failed to fetch weather after "</span>, max_attempts, <span class="st">" attempts for "</span>,</span>
<span id="cb75-218"><a href="#cb75-218" aria-hidden="true" tabindex="-1"></a>          start_date, <span class="st">"–"</span>, end_date)</span>
<span id="cb75-219"><a href="#cb75-219" aria-hidden="true" tabindex="-1"></a>  <span class="cn">NULL</span></span>
<span id="cb75-220"><a href="#cb75-220" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-221"><a href="#cb75-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-222"><a href="#cb75-222" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-223"><a href="#cb75-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-224"><a href="#cb75-224" aria-hidden="true" tabindex="-1"></a>Build a list of month ranges, call the API month-by-month, combine results, and save.</span>
<span id="cb75-225"><a href="#cb75-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-226"><a href="#cb75-226" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`Sys.sleep(0.5)`</span> is a rate-limit to reduce API stress</span>
<span id="cb75-227"><a href="#cb75-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-228"><a href="#cb75-228" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span><span class="in">`head()`</span>/<span class="in">`tail()`</span> prints are quick checks to make sure that data has properly settled</span>
<span id="cb75-229"><a href="#cb75-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-232"><a href="#cb75-232" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-233"><a href="#cb75-233" aria-hidden="true" tabindex="-1"></a>date_ranges <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb75-234"><a href="#cb75-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2024-10-01"</span>, <span class="at">end =</span> <span class="st">"2024-10-31"</span>),</span>
<span id="cb75-235"><a href="#cb75-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2024-11-01"</span>, <span class="at">end =</span> <span class="st">"2024-11-30"</span>),</span>
<span id="cb75-236"><a href="#cb75-236" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2024-12-01"</span>, <span class="at">end =</span> <span class="st">"2024-12-31"</span>),</span>
<span id="cb75-237"><a href="#cb75-237" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-01-01"</span>, <span class="at">end =</span> <span class="st">"2025-01-31"</span>),</span>
<span id="cb75-238"><a href="#cb75-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-02-01"</span>, <span class="at">end =</span> <span class="st">"2025-02-28"</span>),</span>
<span id="cb75-239"><a href="#cb75-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-03-01"</span>, <span class="at">end =</span> <span class="st">"2025-03-31"</span>),</span>
<span id="cb75-240"><a href="#cb75-240" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-04-01"</span>, <span class="at">end =</span> <span class="st">"2025-04-30"</span>),</span>
<span id="cb75-241"><a href="#cb75-241" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-05-01"</span>, <span class="at">end =</span> <span class="st">"2025-05-31"</span>),</span>
<span id="cb75-242"><a href="#cb75-242" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-06-01"</span>, <span class="at">end =</span> <span class="st">"2025-06-30"</span>),</span>
<span id="cb75-243"><a href="#cb75-243" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-07-01"</span>, <span class="at">end =</span> <span class="st">"2025-07-31"</span>),</span>
<span id="cb75-244"><a href="#cb75-244" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-08-01"</span>, <span class="at">end =</span> <span class="st">"2025-08-31"</span>),</span>
<span id="cb75-245"><a href="#cb75-245" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-09-01"</span>, <span class="at">end =</span> <span class="st">"2025-09-30"</span>),</span>
<span id="cb75-246"><a href="#cb75-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">start =</span> <span class="st">"2025-10-01"</span>, <span class="at">end =</span> <span class="st">"2025-10-31"</span>)</span>
<span id="cb75-247"><a href="#cb75-247" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-248"><a href="#cb75-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-249"><a href="#cb75-249" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Getting daily weather data for Manhattan</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-250"><a href="#cb75-250" aria-hidden="true" tabindex="-1"></a>weather_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(date_ranges))</span>
<span id="cb75-251"><a href="#cb75-251" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-252"><a href="#cb75-252" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(date_ranges)) {</span>
<span id="cb75-253"><a href="#cb75-253" aria-hidden="true" tabindex="-1"></a>  dr <span class="ot">&lt;-</span> date_ranges[[i]]</span>
<span id="cb75-254"><a href="#cb75-254" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"  "</span>, dr<span class="sc">$</span>start, <span class="st">"–"</span>, dr<span class="sc">$</span>end, <span class="st">"...</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-255"><a href="#cb75-255" aria-hidden="true" tabindex="-1"></a>  weather_list[[i]] <span class="ot">&lt;-</span> <span class="fu">get_monthly_weather</span>(latitude, longitude, dr<span class="sc">$</span>start, dr<span class="sc">$</span>end)</span>
<span id="cb75-256"><a href="#cb75-256" aria-hidden="true" tabindex="-1"></a>  <span class="fu">Sys.sleep</span>(<span class="fl">0.5</span>)</span>
<span id="cb75-257"><a href="#cb75-257" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-258"><a href="#cb75-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-259"><a href="#cb75-259" aria-hidden="true" tabindex="-1"></a>weather_daily <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(weather_list, <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-260"><a href="#cb75-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-261"><a href="#cb75-261" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">head</span>(weather_daily))</span>
<span id="cb75-262"><a href="#cb75-262" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">tail</span>(weather_daily))</span>
<span id="cb75-263"><a href="#cb75-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-264"><a href="#cb75-264" aria-hidden="true" tabindex="-1"></a>weather_out <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"weather_daily_10036_202410_202510.rds"</span>)</span>
<span id="cb75-265"><a href="#cb75-265" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(weather_daily, weather_out)</span>
<span id="cb75-266"><a href="#cb75-266" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Saved daily weather to: "</span>, weather_out)</span>
<span id="cb75-267"><a href="#cb75-267" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-268"><a href="#cb75-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-269"><a href="#cb75-269" aria-hidden="true" tabindex="-1"></a><span class="fu">## 3. Data Filtering</span></span>
<span id="cb75-270"><a href="#cb75-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-271"><a href="#cb75-271" aria-hidden="true" tabindex="-1"></a><span class="fu">### Download, Unzip, Read, Filter for Manhattan Only Trips</span></span>
<span id="cb75-272"><a href="#cb75-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-273"><a href="#cb75-273" aria-hidden="true" tabindex="-1"></a>First, we must download all files relevant to October 2024 to October 2025 from the Citi Bike website.</span>
<span id="cb75-274"><a href="#cb75-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-275"><a href="#cb75-275" aria-hidden="true" tabindex="-1"></a>Afterwards, we must filter for Manhattan only trips. For one month <span class="in">`m`</span>, return a <span class="in">`data.table`</span> containing only trips whose **starting latitude/longitude** falls inside Manhattan.</span>
<span id="cb75-276"><a href="#cb75-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-277"><a href="#cb75-277" aria-hidden="true" tabindex="-1"></a>::: {.callout-note title="Why start location only?"}</span>
<span id="cb75-278"><a href="#cb75-278" aria-hidden="true" tabindex="-1"></a>We filter trips by **starting latitude/longitude** because that’s where riders actually makes the decision to rent a bike, so it best reflects *Manhattan demand*.</span>
<span id="cb75-279"><a href="#cb75-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-280"><a href="#cb75-280" aria-hidden="true" tabindex="-1"></a>**Limitations:** This will still include trips that end outside Manhattan, while excluding trips that *start outside* Manhattan but end inside. It also assumes the recorded start coordinates are accurate.</span>
<span id="cb75-281"><a href="#cb75-281" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-282"><a href="#cb75-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-283"><a href="#cb75-283" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE, warning=FALSE}</span></span>
<span id="cb75-284"><a href="#cb75-284" aria-hidden="true" tabindex="-1"></a>download_zip <span class="ot">&lt;-</span> <span class="cf">function</span>(m, <span class="at">max_attempts =</span> <span class="dv">5</span>) {</span>
<span id="cb75-285"><a href="#cb75-285" aria-hidden="true" tabindex="-1"></a>  zip_name <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s-citibike-tripdata.zip"</span>, m)</span>
<span id="cb75-286"><a href="#cb75-286" aria-hidden="true" tabindex="-1"></a>  zip_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(raw_dir, zip_name)</span>
<span id="cb75-287"><a href="#cb75-287" aria-hidden="true" tabindex="-1"></a>  zip_url  <span class="ot">&lt;-</span> <span class="fu">paste0</span>(base_url, <span class="st">"/"</span>, zip_name)</span>
<span id="cb75-288"><a href="#cb75-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-289"><a href="#cb75-289" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(zip_path)) {</span>
<span id="cb75-290"><a href="#cb75-290" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Zip already exists: "</span>, zip_name)</span>
<span id="cb75-291"><a href="#cb75-291" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(zip_path)</span>
<span id="cb75-292"><a href="#cb75-292" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-293"><a href="#cb75-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-294"><a href="#cb75-294" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (attempt <span class="cf">in</span> <span class="fu">seq_len</span>(max_attempts)) {</span>
<span id="cb75-295"><a href="#cb75-295" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"Downloading (attempt "</span>, attempt, <span class="st">"): "</span>, zip_name)</span>
<span id="cb75-296"><a href="#cb75-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-297"><a href="#cb75-297" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">file.exists</span>(zip_path)) <span class="fu">file.remove</span>(zip_path)</span>
<span id="cb75-298"><a href="#cb75-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-299"><a href="#cb75-299" aria-hidden="true" tabindex="-1"></a>    ok <span class="ot">&lt;-</span> <span class="fu">tryCatch</span>({</span>
<span id="cb75-300"><a href="#cb75-300" aria-hidden="true" tabindex="-1"></a>      utils<span class="sc">::</span><span class="fu">download.file</span>(zip_url, zip_path, <span class="at">mode =</span> <span class="st">"wb"</span>, <span class="at">quiet =</span> <span class="cn">FALSE</span>)</span>
<span id="cb75-301"><a href="#cb75-301" aria-hidden="true" tabindex="-1"></a>      <span class="cn">TRUE</span></span>
<span id="cb75-302"><a href="#cb75-302" aria-hidden="true" tabindex="-1"></a>    }, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb75-303"><a href="#cb75-303" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"  Download error: "</span>, <span class="fu">conditionMessage</span>(e))</span>
<span id="cb75-304"><a href="#cb75-304" aria-hidden="true" tabindex="-1"></a>      <span class="cn">FALSE</span></span>
<span id="cb75-305"><a href="#cb75-305" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb75-306"><a href="#cb75-306" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-307"><a href="#cb75-307" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (ok <span class="sc">&amp;&amp;</span> <span class="fu">file.exists</span>(zip_path)) {</span>
<span id="cb75-308"><a href="#cb75-308" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"  Download complete: "</span>, zip_name)</span>
<span id="cb75-309"><a href="#cb75-309" aria-hidden="true" tabindex="-1"></a>      <span class="fu">return</span>(zip_path)</span>
<span id="cb75-310"><a href="#cb75-310" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-311"><a href="#cb75-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-312"><a href="#cb75-312" aria-hidden="true" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(<span class="dv">10</span> <span class="sc">*</span> attempt)</span>
<span id="cb75-313"><a href="#cb75-313" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-314"><a href="#cb75-314" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-315"><a href="#cb75-315" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Failed to download after "</span>, max_attempts, <span class="st">" attempts: "</span>, zip_url)</span>
<span id="cb75-316"><a href="#cb75-316" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-317"><a href="#cb75-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-318"><a href="#cb75-318" aria-hidden="true" tabindex="-1"></a>process_month_manhattan <span class="ot">&lt;-</span> <span class="cf">function</span>(m) {</span>
<span id="cb75-319"><a href="#cb75-319" aria-hidden="true" tabindex="-1"></a>  zip_name <span class="ot">&lt;-</span> <span class="fu">sprintf</span>(<span class="st">"%s-citibike-tripdata.zip"</span>, m)</span>
<span id="cb75-320"><a href="#cb75-320" aria-hidden="true" tabindex="-1"></a>  zip_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(raw_dir, zip_name)</span>
<span id="cb75-321"><a href="#cb75-321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-322"><a href="#cb75-322" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download if missing</span></span>
<span id="cb75-323"><a href="#cb75-323" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(zip_path)) {</span>
<span id="cb75-324"><a href="#cb75-324" aria-hidden="true" tabindex="-1"></a>    zip_path <span class="ot">&lt;-</span> <span class="fu">download_zip</span>(m)</span>
<span id="cb75-325"><a href="#cb75-325" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-326"><a href="#cb75-326" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-327"><a href="#cb75-327" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"</span><span class="sc">\n</span><span class="st"> Processing month: "</span>, m)</span>
<span id="cb75-328"><a href="#cb75-328" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-329"><a href="#cb75-329" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 1) Unzip to a temporary directory</span></span>
<span id="cb75-330"><a href="#cb75-330" aria-hidden="true" tabindex="-1"></a>  tmpdir <span class="ot">&lt;-</span> <span class="fu">file.path</span>(<span class="fu">tempdir</span>(), m)</span>
<span id="cb75-331"><a href="#cb75-331" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(tmpdir, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span>
<span id="cb75-332"><a href="#cb75-332" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(zip_path, <span class="at">exdir =</span> tmpdir)</span>
<span id="cb75-333"><a href="#cb75-333" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-334"><a href="#cb75-334" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 2) List CSV files inside the unzipped folder</span></span>
<span id="cb75-335"><a href="#cb75-335" aria-hidden="true" tabindex="-1"></a>  csv_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(tmpdir, <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.csv$"</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-336"><a href="#cb75-336" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-337"><a href="#cb75-337" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(csv_files) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb75-338"><a href="#cb75-338" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(<span class="st">"No CSV files found in "</span>, zip_path)</span>
<span id="cb75-339"><a href="#cb75-339" aria-hidden="true" tabindex="-1"></a>    <span class="fu">unlink</span>(tmpdir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-340"><a href="#cb75-340" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb75-341"><a href="#cb75-341" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-342"><a href="#cb75-342" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-343"><a href="#cb75-343" aria-hidden="true" tabindex="-1"></a>  month_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(csv_files))</span>
<span id="cb75-344"><a href="#cb75-344" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-345"><a href="#cb75-345" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 3) Process each CSV</span></span>
<span id="cb75-346"><a href="#cb75-346" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(csv_files)) {</span>
<span id="cb75-347"><a href="#cb75-347" aria-hidden="true" tabindex="-1"></a>    csv <span class="ot">&lt;-</span> csv_files[i]</span>
<span id="cb75-348"><a href="#cb75-348" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">"  Reading: "</span>, <span class="fu">basename</span>(csv))</span>
<span id="cb75-349"><a href="#cb75-349" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-350"><a href="#cb75-350" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> <span class="fu">fread</span>(</span>
<span id="cb75-351"><a href="#cb75-351" aria-hidden="true" tabindex="-1"></a>      csv,</span>
<span id="cb75-352"><a href="#cb75-352" aria-hidden="true" tabindex="-1"></a>      <span class="at">select =</span> <span class="fu">c</span>(</span>
<span id="cb75-353"><a href="#cb75-353" aria-hidden="true" tabindex="-1"></a>        <span class="st">"started_at"</span>,</span>
<span id="cb75-354"><a href="#cb75-354" aria-hidden="true" tabindex="-1"></a>        <span class="st">"ended_at"</span>,</span>
<span id="cb75-355"><a href="#cb75-355" aria-hidden="true" tabindex="-1"></a>        <span class="st">"start_lat"</span>, <span class="st">"start_lng"</span></span>
<span id="cb75-356"><a href="#cb75-356" aria-hidden="true" tabindex="-1"></a>      )</span>
<span id="cb75-357"><a href="#cb75-357" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-358"><a href="#cb75-358" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-359"><a href="#cb75-359" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert to POSIXct</span></span>
<span id="cb75-360"><a href="#cb75-360" aria-hidden="true" tabindex="-1"></a>    dt[, started_at <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(started_at, <span class="at">tz =</span> <span class="st">"America/New_York"</span>)]</span>
<span id="cb75-361"><a href="#cb75-361" aria-hidden="true" tabindex="-1"></a>    dt[, ended_at   <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(ended_at,   <span class="at">tz =</span> <span class="st">"America/New_York"</span>)]</span>
<span id="cb75-362"><a href="#cb75-362" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-363"><a href="#cb75-363" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Date/hour format</span></span>
<span id="cb75-364"><a href="#cb75-364" aria-hidden="true" tabindex="-1"></a>    dt[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(started_at)]</span>
<span id="cb75-365"><a href="#cb75-365" aria-hidden="true" tabindex="-1"></a>    dt[, hour <span class="sc">:</span><span class="er">=</span> <span class="fu">as.integer</span>(<span class="fu">format</span>(started_at, <span class="st">"%H"</span>))]</span>
<span id="cb75-366"><a href="#cb75-366" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-367"><a href="#cb75-367" aria-hidden="true" tabindex="-1"></a>    <span class="co"># GIS filter: keep only trips whose starting long. and lat. point are in Manhattan </span></span>
<span id="cb75-368"><a href="#cb75-368" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1) Drop rows with missing start coordinates</span></span>
<span id="cb75-369"><a href="#cb75-369" aria-hidden="true" tabindex="-1"></a>    n_before <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt)</span>
<span id="cb75-370"><a href="#cb75-370" aria-hidden="true" tabindex="-1"></a>    dt <span class="ot">&lt;-</span> dt[<span class="sc">!</span><span class="fu">is.na</span>(start_lat) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(start_lng)]</span>
<span id="cb75-371"><a href="#cb75-371" aria-hidden="true" tabindex="-1"></a>    n_after  <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt)</span>
<span id="cb75-372"><a href="#cb75-372" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-373"><a href="#cb75-373" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_after <span class="sc">==</span> <span class="dv">0</span>L) {</span>
<span id="cb75-374"><a href="#cb75-374" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"    All rows in this CSV had missing start coords; skipping."</span>)</span>
<span id="cb75-375"><a href="#cb75-375" aria-hidden="true" tabindex="-1"></a>      month_list[[i]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb75-376"><a href="#cb75-376" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb75-377"><a href="#cb75-377" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-378"><a href="#cb75-378" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-379"><a href="#cb75-379" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (n_after <span class="sc">&lt;</span> n_before) {</span>
<span id="cb75-380"><a href="#cb75-380" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"    Dropped "</span>, n_before <span class="sc">-</span> n_after, <span class="st">" rows with missing start coords."</span>)</span>
<span id="cb75-381"><a href="#cb75-381" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-382"><a href="#cb75-382" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-383"><a href="#cb75-383" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2) Convert start coordinates to sf points</span></span>
<span id="cb75-384"><a href="#cb75-384" aria-hidden="true" tabindex="-1"></a>    dt_sf <span class="ot">&lt;-</span> <span class="fu">st_as_sf</span>(</span>
<span id="cb75-385"><a href="#cb75-385" aria-hidden="true" tabindex="-1"></a>      dt,</span>
<span id="cb75-386"><a href="#cb75-386" aria-hidden="true" tabindex="-1"></a>      <span class="at">coords =</span> <span class="fu">c</span>(<span class="st">"start_lng"</span>, <span class="st">"start_lat"</span>),</span>
<span id="cb75-387"><a href="#cb75-387" aria-hidden="true" tabindex="-1"></a>      <span class="at">crs =</span> <span class="dv">4326</span>,</span>
<span id="cb75-388"><a href="#cb75-388" aria-hidden="true" tabindex="-1"></a>      <span class="at">remove =</span> <span class="cn">FALSE</span></span>
<span id="cb75-389"><a href="#cb75-389" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-390"><a href="#cb75-390" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-391"><a href="#cb75-391" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3) Keep only points inside Manhattan polygon</span></span>
<span id="cb75-392"><a href="#cb75-392" aria-hidden="true" tabindex="-1"></a>    inside_manhattan <span class="ot">&lt;-</span> <span class="fu">st_within</span>(dt_sf, manhattan_poly, <span class="at">sparse =</span> <span class="cn">FALSE</span>)[, <span class="dv">1</span>]</span>
<span id="cb75-393"><a href="#cb75-393" aria-hidden="true" tabindex="-1"></a>    dt_manhattan <span class="ot">&lt;-</span> dt_sf[inside_manhattan, ]</span>
<span id="cb75-394"><a href="#cb75-394" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-395"><a href="#cb75-395" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 4) Drop geometry to go back to data.table</span></span>
<span id="cb75-396"><a href="#cb75-396" aria-hidden="true" tabindex="-1"></a>    dt_manhattan <span class="ot">&lt;-</span> <span class="fu">as.data.table</span>(<span class="fu">st_drop_geometry</span>(dt_manhattan))</span>
<span id="cb75-397"><a href="#cb75-397" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-398"><a href="#cb75-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">nrow</span>(dt_manhattan) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb75-399"><a href="#cb75-399" aria-hidden="true" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">"    No Manhattan-start trips in this chunk after GIS filter."</span>)</span>
<span id="cb75-400"><a href="#cb75-400" aria-hidden="true" tabindex="-1"></a>      month_list[[i]] <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb75-401"><a href="#cb75-401" aria-hidden="true" tabindex="-1"></a>      <span class="cf">next</span></span>
<span id="cb75-402"><a href="#cb75-402" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb75-403"><a href="#cb75-403" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-404"><a href="#cb75-404" aria-hidden="true" tabindex="-1"></a>    month_list[[i]] <span class="ot">&lt;-</span> dt_manhattan</span>
<span id="cb75-405"><a href="#cb75-405" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-406"><a href="#cb75-406" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rm</span>(dt, dt_sf, dt_manhattan)</span>
<span id="cb75-407"><a href="#cb75-407" aria-hidden="true" tabindex="-1"></a>    <span class="fu">gc</span>()</span>
<span id="cb75-408"><a href="#cb75-408" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-409"><a href="#cb75-409" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-410"><a href="#cb75-410" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 4) Combine all Manhattan-start trips for this month</span></span>
<span id="cb75-411"><a href="#cb75-411" aria-hidden="true" tabindex="-1"></a>  month_all <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(month_list, <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-412"><a href="#cb75-412" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-413"><a href="#cb75-413" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 5) Clean up temp files</span></span>
<span id="cb75-414"><a href="#cb75-414" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(tmpdir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-415"><a href="#cb75-415" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-416"><a href="#cb75-416" aria-hidden="true" tabindex="-1"></a>  month_all</span>
<span id="cb75-417"><a href="#cb75-417" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-418"><a href="#cb75-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-419"><a href="#cb75-419" aria-hidden="true" tabindex="-1"></a>all_months_list <span class="ot">&lt;-</span> <span class="fu">vector</span>(<span class="st">"list"</span>, <span class="fu">length</span>(months))</span>
<span id="cb75-420"><a href="#cb75-420" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(months)) {</span>
<span id="cb75-421"><a href="#cb75-421" aria-hidden="true" tabindex="-1"></a>  all_months_list[[i]] <span class="ot">&lt;-</span> <span class="fu">process_month_manhattan</span>(months[i])</span>
<span id="cb75-422"><a href="#cb75-422" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gc</span>()</span>
<span id="cb75-423"><a href="#cb75-423" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-424"><a href="#cb75-424" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-425"><a href="#cb75-425" aria-hidden="true" tabindex="-1"></a>citibike_manhattan_all <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(all_months_list, <span class="at">use.names =</span> <span class="cn">TRUE</span>, <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-426"><a href="#cb75-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-427"><a href="#cb75-427" aria-hidden="true" tabindex="-1"></a>citibike_out <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">"citibike_manhattan_all_202410_202510.rds"</span>)</span>
<span id="cb75-428"><a href="#cb75-428" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(citibike_manhattan_all, citibike_out)</span>
<span id="cb75-429"><a href="#cb75-429" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Saved Manhattan-start trips to: "</span>, citibike_out)</span>
<span id="cb75-430"><a href="#cb75-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-431"><a href="#cb75-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-432"><a href="#cb75-432" aria-hidden="true" tabindex="-1"></a>Before, we join our two datasets, we must first clean our raw data directory as there are many files we no longer have any use for.</span>
<span id="cb75-433"><a href="#cb75-433" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-436"><a href="#cb75-436" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-437"><a href="#cb75-437" aria-hidden="true" tabindex="-1"></a><span class="co"># Find only .zip files (non-recursive)</span></span>
<span id="cb75-438"><a href="#cb75-438" aria-hidden="true" tabindex="-1"></a>zip_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(</span>
<span id="cb75-439"><a href="#cb75-439" aria-hidden="true" tabindex="-1"></a>  raw_dir,</span>
<span id="cb75-440"><a href="#cb75-440" aria-hidden="true" tabindex="-1"></a>  <span class="at">pattern =</span> <span class="st">"</span><span class="sc">\\</span><span class="st">.zip$"</span>,</span>
<span id="cb75-441"><a href="#cb75-441" aria-hidden="true" tabindex="-1"></a>  <span class="at">full.names =</span> <span class="cn">TRUE</span></span>
<span id="cb75-442"><a href="#cb75-442" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-443"><a href="#cb75-443" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-444"><a href="#cb75-444" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(zip_files) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb75-445"><a href="#cb75-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Deleting ZIP files in "</span>, raw_dir)</span>
<span id="cb75-446"><a href="#cb75-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unlink</span>(zip_files, <span class="at">force =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-447"><a href="#cb75-447" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"Deleted "</span>, <span class="fu">length</span>(zip_files), <span class="st">" ZIP files."</span>)</span>
<span id="cb75-448"><a href="#cb75-448" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb75-449"><a href="#cb75-449" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">"No ZIP files found in "</span>, raw_dir)</span>
<span id="cb75-450"><a href="#cb75-450" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-451"><a href="#cb75-451" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-452"><a href="#cb75-452" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-453"><a href="#cb75-453" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-454"><a href="#cb75-454" aria-hidden="true" tabindex="-1"></a><span class="fu">## 4. Join Bike and Weather Data</span></span>
<span id="cb75-455"><a href="#cb75-455" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-456"><a href="#cb75-456" aria-hidden="true" tabindex="-1"></a>To start, we have to load the cleaned Manhattan Citi Bike trips file and the daily weather file that we created earlier.</span>
<span id="cb75-457"><a href="#cb75-457" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-460"><a href="#cb75-460" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-461"><a href="#cb75-461" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Loading Citi Bike and weather data</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-462"><a href="#cb75-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-463"><a href="#cb75-463" aria-hidden="true" tabindex="-1"></a><span class="do">## Load data</span></span>
<span id="cb75-464"><a href="#cb75-464" aria-hidden="true" tabindex="-1"></a>citibike_path <span class="ot">&lt;-</span> <span class="st">"data/processed/citibike_manhattan_all_202410_202510.rds"</span></span>
<span id="cb75-465"><a href="#cb75-465" aria-hidden="true" tabindex="-1"></a>weather_path  <span class="ot">&lt;-</span> <span class="st">"data/processed/weather_daily_10036_202410_202510.rds"</span></span>
<span id="cb75-466"><a href="#cb75-466" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-467"><a href="#cb75-467" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(citibike_path)) <span class="fu">stop</span>(<span class="st">"Missing Citi Bike file"</span>)</span>
<span id="cb75-468"><a href="#cb75-468" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(weather_path)) <span class="fu">stop</span>(<span class="st">"Missing weather file"</span>)</span>
<span id="cb75-469"><a href="#cb75-469" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-470"><a href="#cb75-470" aria-hidden="true" tabindex="-1"></a>citibike <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(citibike_path)</span>
<span id="cb75-471"><a href="#cb75-471" aria-hidden="true" tabindex="-1"></a>daily_weather <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(weather_path)</span>
<span id="cb75-472"><a href="#cb75-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-473"><a href="#cb75-473" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(citibike)</span>
<span id="cb75-474"><a href="#cb75-474" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(daily_weather)</span>
<span id="cb75-475"><a href="#cb75-475" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-476"><a href="#cb75-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-477"><a href="#cb75-477" aria-hidden="true" tabindex="-1"></a>Citi Bike data is trip-level (many rows per day), so we first collapse it into one row per day by counting trips.</span>
<span id="cb75-478"><a href="#cb75-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-481"><a href="#cb75-481" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-482"><a href="#cb75-482" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Building daily Citi Bike trip counts</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-483"><a href="#cb75-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-484"><a href="#cb75-484" aria-hidden="true" tabindex="-1"></a><span class="do">## Build daily trips</span></span>
<span id="cb75-485"><a href="#cb75-485" aria-hidden="true" tabindex="-1"></a>citibike[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(started_at)]</span>
<span id="cb75-486"><a href="#cb75-486" aria-hidden="true" tabindex="-1"></a>daily_trips <span class="ot">&lt;-</span> citibike[, .(<span class="at">n_trips =</span> .N), by <span class="ot">=</span> .(date)]</span>
<span id="cb75-487"><a href="#cb75-487" aria-hidden="true" tabindex="-1"></a>daily_trips <span class="ot">&lt;-</span> daily_trips[date <span class="sc">&gt;=</span> <span class="st">"2024-10-01"</span> <span class="sc">&amp;</span> date <span class="sc">&lt;=</span> <span class="st">"2025-10-31"</span>]</span>
<span id="cb75-488"><a href="#cb75-488" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(daily_trips, date)</span>
<span id="cb75-489"><a href="#cb75-489" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-490"><a href="#cb75-490" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-491"><a href="#cb75-491" aria-hidden="true" tabindex="-1"></a>Now both datasets are daily, so we merge them on date.\</span>
<span id="cb75-492"><a href="#cb75-492" aria-hidden="true" tabindex="-1"></a><span class="in">`all.x = TRUE`</span> keeps all days with Citi Bike trips, even if weather is missing.</span>
<span id="cb75-493"><a href="#cb75-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-496"><a href="#cb75-496" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-497"><a href="#cb75-497" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Merging Citi Bike daily counts with weather</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-498"><a href="#cb75-498" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-499"><a href="#cb75-499" aria-hidden="true" tabindex="-1"></a><span class="do">## Merge trips + weather</span></span>
<span id="cb75-500"><a href="#cb75-500" aria-hidden="true" tabindex="-1"></a>daily <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb75-501"><a href="#cb75-501" aria-hidden="true" tabindex="-1"></a>  daily_trips,</span>
<span id="cb75-502"><a href="#cb75-502" aria-hidden="true" tabindex="-1"></a>  daily_weather,</span>
<span id="cb75-503"><a href="#cb75-503" aria-hidden="true" tabindex="-1"></a>  <span class="at">by =</span> <span class="st">"date"</span>,</span>
<span id="cb75-504"><a href="#cb75-504" aria-hidden="true" tabindex="-1"></a>  <span class="at">all.x =</span> <span class="cn">TRUE</span></span>
<span id="cb75-505"><a href="#cb75-505" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-506"><a href="#cb75-506" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-507"><a href="#cb75-507" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-508"><a href="#cb75-508" aria-hidden="true" tabindex="-1"></a><span class="fu">### EDA: Summary Check</span></span>
<span id="cb75-509"><a href="#cb75-509" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-510"><a href="#cb75-510" aria-hidden="true" tabindex="-1"></a>Before making any plots or models, we must first check that the data looks correct. This step confirms that there is one row per day, that the dates cover the expected time period, and that ridership, temperature, and precipitation values fall within reasonable ranges. Doing this helps ensure that later results are based on real patterns in the data and not on data errors.</span>
<span id="cb75-511"><a href="#cb75-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-514"><a href="#cb75-514" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-515"><a href="#cb75-515" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Rows (days):"</span>, <span class="fu">nrow</span>(daily), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-516"><a href="#cb75-516" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Date range :"</span>, <span class="fu">min</span>(daily<span class="sc">$</span>date, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"to"</span>, <span class="fu">max</span>(daily<span class="sc">$</span>date, <span class="at">na.rm =</span> <span class="cn">TRUE</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-517"><a href="#cb75-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-518"><a href="#cb75-518" aria-hidden="true" tabindex="-1"></a>dup_days <span class="ot">&lt;-</span> daily[, .N, by <span class="ot">=</span> date][N <span class="sc">&gt;</span> <span class="dv">1</span>]</span>
<span id="cb75-519"><a href="#cb75-519" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">nrow</span>(dup_days) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb75-520"><a href="#cb75-520" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(dup_days)</span>
<span id="cb75-521"><a href="#cb75-521" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"EDA check failed: duplicated dates found in daily panel."</span>)</span>
<span id="cb75-522"><a href="#cb75-522" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb75-523"><a href="#cb75-523" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"EDA check: OK — one row per day.</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-524"><a href="#cb75-524" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-525"><a href="#cb75-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-526"><a href="#cb75-526" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(daily[, .(n_trips, temp_mean_F, precip_in)])</span>
<span id="cb75-527"><a href="#cb75-527" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-528"><a href="#cb75-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-529"><a href="#cb75-529" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>The dataset contains 396 days with exactly one observation per day, confirming that the daily aggregation is correct</span>
<span id="cb75-530"><a href="#cb75-530" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-531"><a href="#cb75-531" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- --&gt;</span></span>
<span id="cb75-532"><a href="#cb75-532" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-533"><a href="#cb75-533" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Daily ridership varies widely, from about 13,000 to 130,000 trips, showing that demand changes a lot from day to day</span>
<span id="cb75-534"><a href="#cb75-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-535"><a href="#cb75-535" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- --&gt;</span></span>
<span id="cb75-536"><a href="#cb75-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-537"><a href="#cb75-537" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Temperature covers a large range (about 10°F to 94°F) and changes smoothly across the year, suggesting it strongly affects ridership</span>
<span id="cb75-538"><a href="#cb75-538" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-539"><a href="#cb75-539" aria-hidden="true" tabindex="-1"></a><span class="fu">### EDA: Outlier Check</span></span>
<span id="cb75-540"><a href="#cb75-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-541"><a href="#cb75-541" aria-hidden="true" tabindex="-1"></a>To check whether very high ridership days are caused by data problems or by real rider behavior, we look at the weather on those highest-demand days.</span>
<span id="cb75-542"><a href="#cb75-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-545"><a href="#cb75-545" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-546"><a href="#cb75-546" aria-hidden="true" tabindex="-1"></a><span class="co"># Instead of deleting extremes, we inspect whether low/high ridership days align with extreme weather</span></span>
<span id="cb75-547"><a href="#cb75-547" aria-hidden="true" tabindex="-1"></a>low5  <span class="ot">&lt;-</span> daily[<span class="fu">order</span>(n_trips)][<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>,  .(date, n_trips, temp_mean_F, precip_in)]</span>
<span id="cb75-548"><a href="#cb75-548" aria-hidden="true" tabindex="-1"></a>high5 <span class="ot">&lt;-</span> daily[<span class="fu">order</span>(<span class="sc">-</span>n_trips)][<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, .(date, n_trips, temp_mean_F, precip_in)]</span>
<span id="cb75-549"><a href="#cb75-549" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-550"><a href="#cb75-550" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Lowest 5 ridership days:</span><span class="sc">\n</span><span class="st">"</span>);  low5</span>
<span id="cb75-551"><a href="#cb75-551" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Highest 5 ridership days:</span><span class="sc">\n</span><span class="st">"</span>); high5</span>
<span id="cb75-552"><a href="#cb75-552" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-553"><a href="#cb75-553" aria-hidden="true" tabindex="-1"></a><span class="co"># Simple rule-of-thumb flags</span></span>
<span id="cb75-554"><a href="#cb75-554" aria-hidden="true" tabindex="-1"></a>daily[, flag_low_trips <span class="sc">:</span><span class="er">=</span> n_trips <span class="sc">&lt;</span> <span class="fu">quantile</span>(n_trips, <span class="fl">0.01</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb75-555"><a href="#cb75-555" aria-hidden="true" tabindex="-1"></a>daily[, flag_high_trips <span class="sc">:</span><span class="er">=</span> n_trips <span class="sc">&gt;</span> <span class="fu">quantile</span>(n_trips, <span class="fl">0.99</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)]</span>
<span id="cb75-556"><a href="#cb75-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-557"><a href="#cb75-557" aria-hidden="true" tabindex="-1"></a>daily[flag_low_trips <span class="sc">==</span> <span class="cn">TRUE</span>,  .(<span class="at">n_days =</span> .N,</span>
<span id="cb75-558"><a href="#cb75-558" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_temp =</span> <span class="fu">mean</span>(temp_mean_F, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb75-559"><a href="#cb75-559" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_prec =</span> <span class="fu">mean</span>(precip_in, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))] <span class="sc">|&gt;</span> <span class="fu">print</span>()</span>
<span id="cb75-560"><a href="#cb75-560" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-561"><a href="#cb75-561" aria-hidden="true" tabindex="-1"></a>daily[flag_high_trips <span class="sc">==</span> <span class="cn">TRUE</span>, .(<span class="at">n_days =</span> .N,</span>
<span id="cb75-562"><a href="#cb75-562" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_temp =</span> <span class="fu">mean</span>(temp_mean_F, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb75-563"><a href="#cb75-563" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">avg_prec =</span> <span class="fu">mean</span>(precip_in, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))] <span class="sc">|&gt;</span> <span class="fu">print</span>()</span>
<span id="cb75-564"><a href="#cb75-564" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-565"><a href="#cb75-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-566"><a href="#cb75-566" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>There are 4 extremely high-ridership days in the dataset</span>
<span id="cb75-567"><a href="#cb75-567" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-568"><a href="#cb75-568" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- --&gt;</span></span>
<span id="cb75-569"><a href="#cb75-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-570"><a href="#cb75-570" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>These days have an average temperature of about 72°F, which is comfortable for biking</span>
<span id="cb75-571"><a href="#cb75-571" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-572"><a href="#cb75-572" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Average precipitation is very low (\~0.05 inches), indicating mostly dry conditions</span>
<span id="cb75-573"><a href="#cb75-573" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-574"><a href="#cb75-574" aria-hidden="true" tabindex="-1"></a><span class="co">&lt;!-- --&gt;</span></span>
<span id="cb75-575"><a href="#cb75-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-576"><a href="#cb75-576" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>These weather patterns are realistic and favorable, suggesting the high ridership reflects true behavior, not data errors</span>
<span id="cb75-577"><a href="#cb75-577" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-578"><a href="#cb75-578" aria-hidden="true" tabindex="-1"></a><span class="fu">### EDA: Precipitation Threshold</span></span>
<span id="cb75-579"><a href="#cb75-579" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-580"><a href="#cb75-580" aria-hidden="true" tabindex="-1"></a>Before studying how rain affects ridership, we first look at how often each rain level appears in the data given certain thresholds.</span>
<span id="cb75-581"><a href="#cb75-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-584"><a href="#cb75-584" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-585"><a href="#cb75-585" aria-hidden="true" tabindex="-1"></a><span class="co"># precipitation likely acts via thresholds, not smoothly</span></span>
<span id="cb75-586"><a href="#cb75-586" aria-hidden="true" tabindex="-1"></a>daily[, rain_cat <span class="sc">:</span><span class="er">=</span> <span class="fu">fifelse</span>(</span>
<span id="cb75-587"><a href="#cb75-587" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.na</span>(precip_in), <span class="cn">NA_character_</span>,</span>
<span id="cb75-588"><a href="#cb75-588" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fifelse</span>(precip_in <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"None"</span>,</span>
<span id="cb75-589"><a href="#cb75-589" aria-hidden="true" tabindex="-1"></a>    <span class="fu">fifelse</span>(precip_in <span class="sc">&lt;=</span> <span class="fl">0.10</span>, <span class="st">"Light"</span>,</span>
<span id="cb75-590"><a href="#cb75-590" aria-hidden="true" tabindex="-1"></a>      <span class="fu">fifelse</span>(precip_in <span class="sc">&lt;=</span> <span class="fl">0.30</span>, <span class="st">"Moderate"</span>, <span class="st">"Heavy"</span>)</span>
<span id="cb75-591"><a href="#cb75-591" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-592"><a href="#cb75-592" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-593"><a href="#cb75-593" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb75-594"><a href="#cb75-594" aria-hidden="true" tabindex="-1"></a>daily[, rain_cat <span class="sc">:</span><span class="er">=</span> <span class="fu">factor</span>(rain_cat, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"None"</span>,<span class="st">"Light"</span>,<span class="st">"Moderate"</span>,<span class="st">"Heavy"</span>))]</span>
<span id="cb75-595"><a href="#cb75-595" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-596"><a href="#cb75-596" aria-hidden="true" tabindex="-1"></a><span class="co"># Distribution of days by category</span></span>
<span id="cb75-597"><a href="#cb75-597" aria-hidden="true" tabindex="-1"></a>daily[, .N, by <span class="ot">=</span> rain_cat][<span class="fu">order</span>(rain_cat)]</span>
<span id="cb75-598"><a href="#cb75-598" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-599"><a href="#cb75-599" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-600"><a href="#cb75-600" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>"None" accounts for more than half of all days</span>
<span id="cb75-601"><a href="#cb75-601" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-602"><a href="#cb75-602" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Precipitation's predictive value comes from a small subset of days, not from day-to-day variation</span>
<span id="cb75-603"><a href="#cb75-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-604"><a href="#cb75-604" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Because precipitation only influences ridership on a limited number of days, its overall importance can appear smaller in aggregate models</span>
<span id="cb75-605"><a href="#cb75-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-606"><a href="#cb75-606" aria-hidden="true" tabindex="-1"></a>This saves the final day-level dataset that will be used as input for the graphs/models.</span>
<span id="cb75-607"><a href="#cb75-607" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-610"><a href="#cb75-610" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-611"><a href="#cb75-611" aria-hidden="true" tabindex="-1"></a><span class="fu">dir.create</span>(<span class="st">"shiny"</span>,     <span class="at">showWarnings =</span> <span class="cn">FALSE</span>, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-612"><a href="#cb75-612" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-613"><a href="#cb75-613" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Saving combined daily panel</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-614"><a href="#cb75-614" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-615"><a href="#cb75-615" aria-hidden="true" tabindex="-1"></a><span class="do">## Save merged panel</span></span>
<span id="cb75-616"><a href="#cb75-616" aria-hidden="true" tabindex="-1"></a>panel_path <span class="ot">&lt;-</span> <span class="st">"data/processed/daily_trips_weather_202410_202510.rds"</span></span>
<span id="cb75-617"><a href="#cb75-617" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(daily, panel_path)</span>
<span id="cb75-618"><a href="#cb75-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-619"><a href="#cb75-619" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Saved daily panel to:"</span>, panel_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-620"><a href="#cb75-620" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-621"><a href="#cb75-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-622"><a href="#cb75-622" aria-hidden="true" tabindex="-1"></a><span class="do">## Save merged panel for shiny deployment</span></span>
<span id="cb75-623"><a href="#cb75-623" aria-hidden="true" tabindex="-1"></a>panel_path <span class="ot">&lt;-</span> <span class="st">"shiny/daily_trips_weather_202410_202510.rds"</span></span>
<span id="cb75-624"><a href="#cb75-624" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(daily, panel_path)</span>
<span id="cb75-625"><a href="#cb75-625" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-626"><a href="#cb75-626" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Saved daily panel to:"</span>, panel_path, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-627"><a href="#cb75-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-628"><a href="#cb75-628" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-629"><a href="#cb75-629" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-630"><a href="#cb75-630" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-631"><a href="#cb75-631" aria-hidden="true" tabindex="-1"></a><span class="fu">## 5. Plot Data</span></span>
<span id="cb75-632"><a href="#cb75-632" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-633"><a href="#cb75-633" aria-hidden="true" tabindex="-1"></a>Now that we’ve joined the Citi Bike and weather data into one daily dataset, we can move on to the visualization portion.</span>
<span id="cb75-634"><a href="#cb75-634" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-635"><a href="#cb75-635" aria-hidden="true" tabindex="-1"></a>We will be creating two plots that directly answer our weather question:</span>
<span id="cb75-636"><a href="#cb75-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-637"><a href="#cb75-637" aria-hidden="true" tabindex="-1"></a>**(1)** a scatterplot of daily trips versus temperature with a **GAM smooth** to capture any non-linear relationship, and **(2)** a boxplot comparing daily trip volume across **rain intensity categories** to show how precipitation shifts ridership distributions.</span>
<span id="cb75-638"><a href="#cb75-638" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-639"><a href="#cb75-639" aria-hidden="true" tabindex="-1"></a>To access these plots, please use the interactive dashboard below:</span>
<span id="cb75-640"><a href="#cb75-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-643"><a href="#cb75-643" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-644"><a href="#cb75-644" aria-hidden="true" tabindex="-1"></a><span class="do">## Interactive Dashboard</span></span>
<span id="cb75-645"><a href="#cb75-645" aria-hidden="true" tabindex="-1"></a>htmltools<span class="sc">::</span>tags<span class="sc">$</span><span class="fu">iframe</span>(</span>
<span id="cb75-646"><a href="#cb75-646" aria-hidden="true" tabindex="-1"></a>  <span class="at">src =</span> <span class="st">"https://citibikenyc.shinyapps.io/appTemp/"</span>,</span>
<span id="cb75-647"><a href="#cb75-647" aria-hidden="true" tabindex="-1"></a>  <span class="at">style =</span> <span class="st">"width:100%; height:900px; border:0;"</span></span>
<span id="cb75-648"><a href="#cb75-648" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb75-649"><a href="#cb75-649" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-650"><a href="#cb75-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-651"><a href="#cb75-651" aria-hidden="true" tabindex="-1"></a><span class="fu">## 6. Results</span></span>
<span id="cb75-652"><a href="#cb75-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-653"><a href="#cb75-653" aria-hidden="true" tabindex="-1"></a><span class="fu">### What the precipitation figure shows</span></span>
<span id="cb75-654"><a href="#cb75-654" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-655"><a href="#cb75-655" aria-hidden="true" tabindex="-1"></a>Starting with the rain boxplot, we see that for days with no rain, the median is around 92,000–95,000 trips. On days with light rain, the median is similar or slightly higher, indicating that very small amounts of rain do not meaningfully deter rider. It's also worth noting that there are also far more days without rain than lightly rainy days. As such, light rain days are more likely to coincide with favorable conditions such as warmer temperatures.</span>
<span id="cb75-656"><a href="#cb75-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-657"><a href="#cb75-657" aria-hidden="true" tabindex="-1"></a>The effect becomes clear once rain reaches moderate levels. When precipitation increases from none to moderate, the median daily trip count falls by roughly 10,000 trips, dropping to about 83,000–85,000 trips.</span>
<span id="cb75-658"><a href="#cb75-658" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-659"><a href="#cb75-659" aria-hidden="true" tabindex="-1"></a>On days with heavy rain, the median drops to roughly 55,000 trips. That means heavy rain is associated with about 40,000 fewer trips in a single day compared to dry conditions.</span>
<span id="cb75-660"><a href="#cb75-660" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-661"><a href="#cb75-661" aria-hidden="true" tabindex="-1"></a><span class="fu">### What the temperature figure shows</span></span>
<span id="cb75-662"><a href="#cb75-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-663"><a href="#cb75-663" aria-hidden="true" tabindex="-1"></a>The temperature plot tells the same story in a different way. On cold days (around 20–30°F), daily ridership usually falls between 30,000 and 50,000 trips. As temperatures rise into the 60s and low 70s, daily trips increase to over 105,000–110,000.</span>
<span id="cb75-664"><a href="#cb75-664" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-665"><a href="#cb75-665" aria-hidden="true" tabindex="-1"></a>That is a swing of more than 60,000 trips per day across the temperature range. The smooth line also shows that ridership stops increasing once temperatures get very hot (above about 75–80°F), leveling off near 100,000 trips. This suggests that warm weather encourages biking up to a comfortable range, but extreme heat does not continue to increase usage.</span>
<span id="cb75-666"><a href="#cb75-666" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-667"><a href="#cb75-667" aria-hidden="true" tabindex="-1"></a><span class="fu">### Putting temperature and precipitation together</span></span>
<span id="cb75-668"><a href="#cb75-668" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-669"><a href="#cb75-669" aria-hidden="true" tabindex="-1"></a>Taken together, the figures show that temperature and precipitation work in different but complementary ways. Temperature determines how high ridership can go, while precipitation determines how far below that level demand falls. On warm, dry days, ridership regularly exceeds 100,000 trips. On cold or rainy days, daily usage can fall to 50,000 trips or less.</span>
<span id="cb75-670"><a href="#cb75-670" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-671"><a href="#cb75-671" aria-hidden="true" tabindex="-1"></a>::: callout-note</span>
<span id="cb75-672"><a href="#cb75-672" aria-hidden="true" tabindex="-1"></a><span class="fu">## Refer to the LOCO table in the group summary report.</span></span>
<span id="cb75-673"><a href="#cb75-673" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb75-674"><a href="#cb75-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-675"><a href="#cb75-675" aria-hidden="true" tabindex="-1"></a>To conclude, weather causes very large swings in daily Citi Bike usage. From the figures, we see that changes in temperature and rain can reduce or increase daily ridership by 10,000 trips on moderate days and by more than 60,000 trips when comparing cold or rainy days to warm, dry ones. No other factor in the analysis causes changes anywhere near this large.</span>
<span id="cb75-676"><a href="#cb75-676" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-677"><a href="#cb75-677" aria-hidden="true" tabindex="-1"></a>Because weather explains such big day-to-day differences, the model relies heavily on it to make accurate predictions. When we remove weather variables from the model, the model loses this key information. As a result, its predictions become much worse: the average prediction error increases by 2,145 trips per day, and the model’s ability to explain variation in ridership drops by 0.186 in R².</span>
<span id="cb75-678"><a href="#cb75-678" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-679"><a href="#cb75-679" aria-hidden="true" tabindex="-1"></a>This drop in performance is the largest observed when removing any single factor. In simple terms, once the model no longer knows whether a day is warm, cold, dry, or rainy, it struggles to explain why ridership might be around 100,000 trips on one day but closer to 50,000 trips on another. That is why weather emerges as the most important factor in the LOCO analysis.</span>
<span id="cb75-680"><a href="#cb75-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-681"><a href="#cb75-681" aria-hidden="true" tabindex="-1"></a><span class="fu">## 7. Further Analysis: Temperature vs. Precipitation</span></span>
<span id="cb75-682"><a href="#cb75-682" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-683"><a href="#cb75-683" aria-hidden="true" tabindex="-1"></a>To assess their relative impact on weather, we will be applying a leave-one-covariate-out (LOCO) approach that compare the predictive contributions of temperature and precipitation. In this analysis, we start with a model that includes both weather variables (temperature and precipitation), then remove one variable at a time and observe how much the model’s performance changes. If removing a variable causes the model’s accuracy to worsen substantially, that variable is considered more important for predicting daily ridership.</span>
<span id="cb75-684"><a href="#cb75-684" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-685"><a href="#cb75-685" aria-hidden="true" tabindex="-1"></a>We evaluate model performance using two standard metrics:</span>
<span id="cb75-686"><a href="#cb75-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-687"><a href="#cb75-687" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>RMSE (Root Mean Squared Error) measures the typical size of the model’s prediction error, expressed in number of trips per day. A lower RMSE means the model’s predictions are closer to the actual observed ridership.</span>
<span id="cb75-688"><a href="#cb75-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-689"><a href="#cb75-689" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>R² (R-squared) measures how much of the day-to-day variation in Citi Bike ridership the model can explain. Higher R² values indicate that the model captures more of the underlying pattern in the data.</span>
<span id="cb75-690"><a href="#cb75-690" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-691"><a href="#cb75-691" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Load Datasets</span></span>
<span id="cb75-692"><a href="#cb75-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-693"><a href="#cb75-693" aria-hidden="true" tabindex="-1"></a>We load the processed Manhattan Citi Bike trip data and the daily weather data, then convert both into <span class="in">`data.table`</span> objects for efficient data manipulation. All date fields are standardized to ensure the two datasets can be merged accurately at the daily level.</span>
<span id="cb75-694"><a href="#cb75-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-697"><a href="#cb75-697" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-698"><a href="#cb75-698" aria-hidden="true" tabindex="-1"></a>trips <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/processed/citibike_manhattan_all_202410_202510.rds"</span>)</span>
<span id="cb75-699"><a href="#cb75-699" aria-hidden="true" tabindex="-1"></a>wx    <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/processed/weather_daily_10036_202410_202510.rds"</span>)</span>
<span id="cb75-700"><a href="#cb75-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-701"><a href="#cb75-701" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(trips)</span>
<span id="cb75-702"><a href="#cb75-702" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(wx)</span>
<span id="cb75-703"><a href="#cb75-703" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-704"><a href="#cb75-704" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(trips<span class="sc">$</span>started_at, <span class="st">"POSIXct"</span>)) {</span>
<span id="cb75-705"><a href="#cb75-705" aria-hidden="true" tabindex="-1"></a>  trips[, started_at <span class="sc">:</span><span class="er">=</span> <span class="fu">as.POSIXct</span>(started_at, <span class="at">tz =</span> <span class="st">"America/New_York"</span>)]</span>
<span id="cb75-706"><a href="#cb75-706" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-707"><a href="#cb75-707" aria-hidden="true" tabindex="-1"></a>trips[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(started_at)]</span>
<span id="cb75-708"><a href="#cb75-708" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-709"><a href="#cb75-709" aria-hidden="true" tabindex="-1"></a>wx[, date <span class="sc">:</span><span class="er">=</span> <span class="fu">as.Date</span>(date)]</span>
<span id="cb75-710"><a href="#cb75-710" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-711"><a href="#cb75-711" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-712"><a href="#cb75-712" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Define the outcome variable</span></span>
<span id="cb75-713"><a href="#cb75-713" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-714"><a href="#cb75-714" aria-hidden="true" tabindex="-1"></a>Because weather conditions vary by day, we aggregate trip-level data into a daily outcome variable, **`n_trips`**, which represents the total number of Citi Bike trips taken on each date. This aligns the outcome with the temporal scale of the weather data.</span>
<span id="cb75-715"><a href="#cb75-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-718"><a href="#cb75-718" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-719"><a href="#cb75-719" aria-hidden="true" tabindex="-1"></a>y_daily <span class="ot">&lt;-</span> trips[, .(<span class="at">n_trips =</span> .N), by <span class="ot">=</span> date]</span>
<span id="cb75-720"><a href="#cb75-720" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(y_daily, date)</span>
<span id="cb75-721"><a href="#cb75-721" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-722"><a href="#cb75-722" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-723"><a href="#cb75-723" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Select weather predictors</span></span>
<span id="cb75-724"><a href="#cb75-724" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-725"><a href="#cb75-725" aria-hidden="true" tabindex="-1"></a>From the weather dataset, we retain only two variables:</span>
<span id="cb75-726"><a href="#cb75-726" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-727"><a href="#cb75-727" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**`temp_mean_F`**: daily average temperature (°F)</span>
<span id="cb75-728"><a href="#cb75-728" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-729"><a href="#cb75-729" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**`precip_in`**: total daily precipitation (inches)</span>
<span id="cb75-730"><a href="#cb75-730" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-731"><a href="#cb75-731" aria-hidden="true" tabindex="-1"></a>Limiting predictors to just these two variables makes sure that the analysis focuses exclusively on comparing the effects of temperature and precipitation, without introducing additional confounding factors.</span>
<span id="cb75-732"><a href="#cb75-732" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-735"><a href="#cb75-735" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-736"><a href="#cb75-736" aria-hidden="true" tabindex="-1"></a>wx_daily <span class="ot">&lt;-</span> wx[, .(date, temp_mean_F, precip_in)]</span>
<span id="cb75-737"><a href="#cb75-737" aria-hidden="true" tabindex="-1"></a><span class="fu">setkey</span>(wx_daily, date)</span>
<span id="cb75-738"><a href="#cb75-738" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-739"><a href="#cb75-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-740"><a href="#cb75-740" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4. Create the modeling dataset</span></span>
<span id="cb75-741"><a href="#cb75-741" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-742"><a href="#cb75-742" aria-hidden="true" tabindex="-1"></a>We merge the daily trip totals with the daily weather variables by date to form a single modeling dataset. Any days with missing values are removed so that all models are trained and evaluated using the same complete set of observations.</span>
<span id="cb75-743"><a href="#cb75-743" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-746"><a href="#cb75-746" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-747"><a href="#cb75-747" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> <span class="fu">merge</span>(y_daily, wx_daily, <span class="at">by =</span> <span class="st">"date"</span>, <span class="at">all.x =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-748"><a href="#cb75-748" aria-hidden="true" tabindex="-1"></a>dt <span class="ot">&lt;-</span> dt[<span class="sc">!</span><span class="fu">is.na</span>(n_trips) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(temp_mean_F) <span class="sc">&amp;</span> <span class="sc">!</span><span class="fu">is.na</span>(precip_in)]</span>
<span id="cb75-749"><a href="#cb75-749" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(dt, date)</span>
<span id="cb75-750"><a href="#cb75-750" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-751"><a href="#cb75-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-752"><a href="#cb75-752" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5. Use a train/test split</span></span>
<span id="cb75-753"><a href="#cb75-753" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-754"><a href="#cb75-754" aria-hidden="true" tabindex="-1"></a>To prevent information from the future influencing model training, we split the data chronologically. The first 80% of days are used for training, while the remaining 20% are reserved for testing. This time-safe split reflects a realistic forecasting setting.</span>
<span id="cb75-755"><a href="#cb75-755" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-758"><a href="#cb75-758" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-759"><a href="#cb75-759" aria-hidden="true" tabindex="-1"></a>n   <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dt)</span>
<span id="cb75-760"><a href="#cb75-760" aria-hidden="true" tabindex="-1"></a>cut <span class="ot">&lt;-</span> <span class="fu">floor</span>(<span class="fl">0.8</span> <span class="sc">*</span> n)</span>
<span id="cb75-761"><a href="#cb75-761" aria-hidden="true" tabindex="-1"></a>train_dt <span class="ot">&lt;-</span> dt[<span class="dv">1</span><span class="sc">:</span>cut]</span>
<span id="cb75-762"><a href="#cb75-762" aria-hidden="true" tabindex="-1"></a>test_dt  <span class="ot">&lt;-</span> dt[(cut<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>n]</span>
<span id="cb75-763"><a href="#cb75-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-764"><a href="#cb75-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-765"><a href="#cb75-765" aria-hidden="true" tabindex="-1"></a><span class="fu">### 6. Fit and evaluate models</span></span>
<span id="cb75-766"><a href="#cb75-766" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-767"><a href="#cb75-767" aria-hidden="true" tabindex="-1"></a>We define a helper function that fits a **random forest model** using the <span class="in">`ranger`</span> package and evaluates its performance on the test set. Model performance is assessed using two metrics:</span>
<span id="cb75-768"><a href="#cb75-768" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-771"><a href="#cb75-771" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-772"><a href="#cb75-772" aria-hidden="true" tabindex="-1"></a>score_model <span class="ot">&lt;-</span> <span class="cf">function</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="fu">character</span>()) {</span>
<span id="cb75-773"><a href="#cb75-773" aria-hidden="true" tabindex="-1"></a>  x_cols <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="fu">names</span>(train_dt), <span class="fu">c</span>(<span class="st">"date"</span>,<span class="st">"n_trips"</span>, drop_cols))</span>
<span id="cb75-774"><a href="#cb75-774" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-775"><a href="#cb75-775" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> <span class="fu">ranger</span>(</span>
<span id="cb75-776"><a href="#cb75-776" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="fu">as.formula</span>(<span class="fu">paste</span>(<span class="st">"n_trips ~"</span>, <span class="fu">paste</span>(x_cols, <span class="at">collapse =</span> <span class="st">" + "</span>))),</span>
<span id="cb75-777"><a href="#cb75-777" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> train_dt,</span>
<span id="cb75-778"><a href="#cb75-778" aria-hidden="true" tabindex="-1"></a>    <span class="at">num.trees =</span> <span class="dv">500</span>,</span>
<span id="cb75-779"><a href="#cb75-779" aria-hidden="true" tabindex="-1"></a>    <span class="at">mtry =</span> <span class="fu">max</span>(<span class="dv">1</span>, <span class="fu">floor</span>(<span class="fu">sqrt</span>(<span class="fu">length</span>(x_cols)))),</span>
<span id="cb75-780"><a href="#cb75-780" aria-hidden="true" tabindex="-1"></a>    <span class="at">min.node.size =</span> <span class="dv">10</span>,</span>
<span id="cb75-781"><a href="#cb75-781" aria-hidden="true" tabindex="-1"></a>    <span class="at">num.threads =</span> <span class="fu">max</span>(<span class="dv">1</span>, parallel<span class="sc">::</span><span class="fu">detectCores</span>() <span class="sc">-</span> <span class="dv">1</span>)</span>
<span id="cb75-782"><a href="#cb75-782" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb75-783"><a href="#cb75-783" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-784"><a href="#cb75-784" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">data =</span> test_dt)<span class="sc">$</span>predictions</span>
<span id="cb75-785"><a href="#cb75-785" aria-hidden="true" tabindex="-1"></a>  rmse <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>((test_dt<span class="sc">$</span>n_trips <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb75-786"><a href="#cb75-786" aria-hidden="true" tabindex="-1"></a>  r2   <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">-</span> <span class="fu">sum</span>((test_dt<span class="sc">$</span>n_trips <span class="sc">-</span> p)<span class="sc">^</span><span class="dv">2</span>) <span class="sc">/</span> <span class="fu">sum</span>((test_dt<span class="sc">$</span>n_trips <span class="sc">-</span> <span class="fu">mean</span>(test_dt<span class="sc">$</span>n_trips))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb75-787"><a href="#cb75-787" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-788"><a href="#cb75-788" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(<span class="at">rmse =</span> rmse, <span class="at">r2 =</span> r2)</span>
<span id="cb75-789"><a href="#cb75-789" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-790"><a href="#cb75-790" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-791"><a href="#cb75-791" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-792"><a href="#cb75-792" aria-hidden="true" tabindex="-1"></a><span class="fu">### 7. Baseline model</span></span>
<span id="cb75-793"><a href="#cb75-793" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-794"><a href="#cb75-794" aria-hidden="true" tabindex="-1"></a>We first fit a baseline random forest model that includes both temperature and precipitation. The RMSE and R² from this full model serve as reference benchmarks for evaluating the impact of removing each weather variable in the LOCO analysis.</span>
<span id="cb75-795"><a href="#cb75-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-798"><a href="#cb75-798" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-799"><a href="#cb75-799" aria-hidden="true" tabindex="-1"></a>base <span class="ot">&lt;-</span> <span class="fu">score_model</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="fu">character</span>())</span>
<span id="cb75-800"><a href="#cb75-800" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-801"><a href="#cb75-801" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Full model (Temp + Precip)</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-802"><a href="#cb75-802" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"RMSE:"</span>, <span class="fu">round</span>(base<span class="sc">$</span>rmse, <span class="dv">1</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-803"><a href="#cb75-803" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"R^2 :"</span>, <span class="fu">round</span>(base<span class="sc">$</span>r2, <span class="dv">3</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb75-804"><a href="#cb75-804" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-805"><a href="#cb75-805" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-806"><a href="#cb75-806" aria-hidden="true" tabindex="-1"></a><span class="fu">### 8. LOCO: Temperature vs. Precipitation</span></span>
<span id="cb75-807"><a href="#cb75-807" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-808"><a href="#cb75-808" aria-hidden="true" tabindex="-1"></a>We apply the leave-one-covariate-out (LOCO) procedure by refitting the model twice:</span>
<span id="cb75-809"><a href="#cb75-809" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-810"><a href="#cb75-810" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Remove temperature:** the model is trained using precipitation only.</span>
<span id="cb75-811"><a href="#cb75-811" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-812"><a href="#cb75-812" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>**Remove precipitation:** the model is trained using temperature only</span>
<span id="cb75-813"><a href="#cb75-813" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-816"><a href="#cb75-816" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-817"><a href="#cb75-817" aria-hidden="true" tabindex="-1"></a>loco <span class="ot">&lt;-</span> <span class="fu">rbindlist</span>(<span class="fu">list</span>(</span>
<span id="cb75-818"><a href="#cb75-818" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-819"><a href="#cb75-819" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb75-820"><a href="#cb75-820" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">score_model</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="st">"temp_mean_F"</span>)</span>
<span id="cb75-821"><a href="#cb75-821" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb75-822"><a href="#cb75-822" aria-hidden="true" tabindex="-1"></a>      <span class="at">component   =</span> <span class="st">"Temperature"</span>,</span>
<span id="cb75-823"><a href="#cb75-823" aria-hidden="true" tabindex="-1"></a>      <span class="at">rmse        =</span> res<span class="sc">$</span>rmse,</span>
<span id="cb75-824"><a href="#cb75-824" aria-hidden="true" tabindex="-1"></a>      <span class="at">r2          =</span> res<span class="sc">$</span>r2</span>
<span id="cb75-825"><a href="#cb75-825" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-826"><a href="#cb75-826" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb75-827"><a href="#cb75-827" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-828"><a href="#cb75-828" aria-hidden="true" tabindex="-1"></a>  {</span>
<span id="cb75-829"><a href="#cb75-829" aria-hidden="true" tabindex="-1"></a>    res <span class="ot">&lt;-</span> <span class="fu">score_model</span>(train_dt, test_dt, <span class="at">drop_cols =</span> <span class="st">"precip_in"</span>)</span>
<span id="cb75-830"><a href="#cb75-830" aria-hidden="true" tabindex="-1"></a>    <span class="fu">data.table</span>(</span>
<span id="cb75-831"><a href="#cb75-831" aria-hidden="true" tabindex="-1"></a>      <span class="at">component   =</span> <span class="st">"Precipitation"</span>,</span>
<span id="cb75-832"><a href="#cb75-832" aria-hidden="true" tabindex="-1"></a>      <span class="at">rmse        =</span> res<span class="sc">$</span>rmse,</span>
<span id="cb75-833"><a href="#cb75-833" aria-hidden="true" tabindex="-1"></a>      <span class="at">r2          =</span> res<span class="sc">$</span>r2</span>
<span id="cb75-834"><a href="#cb75-834" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb75-835"><a href="#cb75-835" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-836"><a href="#cb75-836" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb75-837"><a href="#cb75-837" aria-hidden="true" tabindex="-1"></a>), <span class="at">fill =</span> <span class="cn">TRUE</span>)</span>
<span id="cb75-838"><a href="#cb75-838" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-839"><a href="#cb75-839" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute deltas vs full model</span></span>
<span id="cb75-840"><a href="#cb75-840" aria-hidden="true" tabindex="-1"></a>loco[, <span class="st">`</span><span class="at">:=</span><span class="st">`</span>(</span>
<span id="cb75-841"><a href="#cb75-841" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_rmse =</span> rmse <span class="sc">-</span> base<span class="sc">$</span>rmse,</span>
<span id="cb75-842"><a href="#cb75-842" aria-hidden="true" tabindex="-1"></a>  <span class="at">delta_r2   =</span> r2   <span class="sc">-</span> base<span class="sc">$</span>r2</span>
<span id="cb75-843"><a href="#cb75-843" aria-hidden="true" tabindex="-1"></a>)]</span>
<span id="cb75-844"><a href="#cb75-844" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-845"><a href="#cb75-845" aria-hidden="true" tabindex="-1"></a><span class="fu">setorder</span>(loco, <span class="sc">-</span>delta_rmse)</span>
<span id="cb75-846"><a href="#cb75-846" aria-hidden="true" tabindex="-1"></a>loco[, rank <span class="sc">:</span><span class="er">=</span> <span class="fu">frank</span>(<span class="sc">-</span>delta_rmse, <span class="at">ties.method =</span> <span class="st">"first"</span>)]</span>
<span id="cb75-847"><a href="#cb75-847" aria-hidden="true" tabindex="-1"></a><span class="fu">setcolorder</span>(loco, <span class="fu">c</span>(<span class="st">"rank"</span>,<span class="st">"component"</span>,<span class="st">"rmse"</span>,<span class="st">"r2"</span>,<span class="st">"delta_rmse"</span>,<span class="st">"delta_r2"</span>))</span>
<span id="cb75-848"><a href="#cb75-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-849"><a href="#cb75-849" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(loco)</span>
<span id="cb75-850"><a href="#cb75-850" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-851"><a href="#cb75-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-852"><a href="#cb75-852" aria-hidden="true" tabindex="-1"></a><span class="fu">### 9. Interpreting the results</span></span>
<span id="cb75-853"><a href="#cb75-853" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-856"><a href="#cb75-856" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb75-857"><a href="#cb75-857" aria-hidden="true" tabindex="-1"></a>loco <span class="sc">|&gt;</span></span>
<span id="cb75-858"><a href="#cb75-858" aria-hidden="true" tabindex="-1"></a>  <span class="fu">gt</span>() <span class="sc">|&gt;</span></span>
<span id="cb75-859"><a href="#cb75-859" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cols_label</span>(</span>
<span id="cb75-860"><a href="#cb75-860" aria-hidden="true" tabindex="-1"></a>    <span class="at">rank =</span> <span class="st">"Rank"</span>,</span>
<span id="cb75-861"><a href="#cb75-861" aria-hidden="true" tabindex="-1"></a>    <span class="at">component =</span> <span class="st">"Dropped"</span>,</span>
<span id="cb75-862"><a href="#cb75-862" aria-hidden="true" tabindex="-1"></a>    <span class="at">rmse =</span> <span class="st">"RMSE (LOCO)"</span>,</span>
<span id="cb75-863"><a href="#cb75-863" aria-hidden="true" tabindex="-1"></a>    <span class="at">r2 =</span> <span class="st">"R² (LOCO)"</span>,</span>
<span id="cb75-864"><a href="#cb75-864" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_rmse =</span> <span class="st">"Δ RMSE vs Full"</span>,</span>
<span id="cb75-865"><a href="#cb75-865" aria-hidden="true" tabindex="-1"></a>    <span class="at">delta_r2 =</span> <span class="st">"Δ R² vs Full"</span></span>
<span id="cb75-866"><a href="#cb75-866" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb75-867"><a href="#cb75-867" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(rmse, delta_rmse), <span class="at">decimals =</span> <span class="dv">0</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-868"><a href="#cb75-868" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fmt_number</span>(<span class="at">columns =</span> <span class="fu">c</span>(r2, delta_r2), <span class="at">decimals =</span> <span class="dv">3</span>) <span class="sc">|&gt;</span></span>
<span id="cb75-869"><a href="#cb75-869" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tab_header</span>(<span class="at">title =</span> <span class="st">"LOCO Weather Importance: Temperature vs Precipitation"</span>)</span>
<span id="cb75-870"><a href="#cb75-870" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb75-871"><a href="#cb75-871" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-872"><a href="#cb75-872" aria-hidden="true" tabindex="-1"></a>The LOCO analysis shows that between the two variables, temperature is the stronger predictor of daily Citi Bike ridership compared to precipitation. When temperature is removed from the model, prediction accuracy declines substantially: the typical prediction error increases by roughly 14,000 trips per day, and the model’s R² becomes strongly negative. This indicates that the model without temperature performs much worse than simply predicting the average number of daily trips, highlighting how essential temperature is for capturing day-to-day variation in ridership.</span>
<span id="cb75-873"><a href="#cb75-873" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-874"><a href="#cb75-874" aria-hidden="true" tabindex="-1"></a>In contrast, removing precipitation also reduces model performance, but to a lesser degree. The increase in prediction error is about 6,300 trips per day, and the drop in R² is smaller than when temperature is removed. This suggests that precipitation provides useful information, particularly for suppressing ridership on rainy days, but it does not explain as much overall variation as temperature.</span>
<span id="cb75-875"><a href="#cb75-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-876"><a href="#cb75-876" aria-hidden="true" tabindex="-1"></a>Some limitations to note are that the effect of precipitation may be understated in this analysis because rainfall is sporadic and short-lived, rather than a consistent condition throughout the day. Aggregating precipitation to the daily level can mask important within-day variation, such as brief rain events that strongly suppress ridership during specific hours but do not persist long enough to substantially affect the daily total.</span>
<span id="cb75-877"><a href="#cb75-877" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-878"><a href="#cb75-878" aria-hidden="true" tabindex="-1"></a>An hourly analysis would better capture these short-term behavioral responses to rain. However, due to memory and computational constraints associated with processing the full trip-level dataset at an hourly resolution, we default to a daily aggregation. As a result, the LOCO comparison likely favors temperature due to exerting a more persistent, day-long influence, while underrepresenting the true impact of precipitation.</span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->




<script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>